name: Build & Release Plugins

on:
  push:
    branches: [main]
    paths:
      - 'napcat-plugin-*/**'
      - '.github/**'
  workflow_dispatch:

permissions: write-all

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´å†å²ï¼Œç¡®ä¿å¤š commit push æ—¶ diff æ­£ç¡®

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Build plugins (incremental)
        env:
          BEFORE_SHA: ${{ github.event.before }}
        run: |
          # workflow_dispatch æ‰‹åŠ¨è§¦å‘æ—¶å…¨é‡æ„å»ºï¼Œpush è§¦å‘æ—¶å¢é‡æ„å»º
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            node .github/scripts/build-plugins.mjs \
              "https://github.com/${{ github.repository }}" \
              "plugins" \
              --all
          else
            node .github/scripts/build-plugins.mjs \
              "https://github.com/${{ github.repository }}" \
              "plugins"
          fi

      - name: Commit plugin.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add plugin.json
          git diff --cached --quiet && echo "plugin.json æ— å˜åŒ–" || {
            git commit -m "chore: auto-update plugin.json [skip ci]"
            git push
          }

      - name: Create or update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="plugins"

          # åˆ›å»º Releaseï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if ! gh release view "$RELEASE_TAG" &>/dev/null; then
            gh release create "$RELEASE_TAG" \
              --title "NapCat Plugins" \
              --notes "è‡ªåŠ¨æ„å»ºçš„æ’ä»¶åŒ…ï¼ŒæŒç»­æ›´æ–°ã€‚" \
              --latest=false
          fi

          # åªä¸Šä¼ æœ¬æ¬¡æ„å»ºäº§ç”Ÿçš„ zipï¼ˆå¢é‡ï¼‰
          shopt -s nullglob
          zips=(.plugin-zips/napcat-plugin-*.zip)
          if [ ${#zips[@]} -eq 0 ]; then
            echo "ğŸ“¦ æœ¬æ¬¡æ— æ–°æ„å»ºçš„ zipï¼Œè·³è¿‡ä¸Šä¼ "
          else
            for zip_file in "${zips[@]}"; do
              echo "ğŸ“¤ ä¸Šä¼ : $(basename $zip_file)"
              gh release upload "$RELEASE_TAG" "$zip_file" --clobber
            done
            echo "âœ… å·²ä¸Šä¼  ${#zips[@]} ä¸ªæ’ä»¶åŒ…"
          fi
