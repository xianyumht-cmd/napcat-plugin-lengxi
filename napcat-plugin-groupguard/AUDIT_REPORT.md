# QQ群管机器人防封审计与改进建议报告

## 1. 现状审计 (Current Status Audit)

通过对 `napcat-plugin-groupguard` 代码的深度分析，结合腾讯QQ对群机器人的风控机制，我们发现当前项目存在以下风险点：

### 1.1 发送频率风险 (High Risk)
- **现状**: 当前代码在 `src/commands.ts` 和 `src/index.ts` 中直接调用 `pluginState.sendGroupMsg` 发送消息，且几乎是收到指令后**立即**回复。
- **风险**: 
  - **秒回**: 机器人的响应速度在毫秒级，这完全不符合人类操作特征，极易被风控系统识别为自动化脚本。
  - **并发爆发**: 在群内发生刷屏或大量用户同时签到时，机器人会在短时间内发送大量消息，触发腾讯的**QPS限制**（每秒查询率），导致账号被冻结或消息被屏蔽（风控）。

### 1.2 行为特征风险 (Medium Risk)
- **现状**: 
  - 踢人（Kick）和禁言（Ban）操作在检测到违规时立即执行。
  - 欢迎语、签到回复等内容高度重复。
- **风险**:
  - **批量操作**: 如果遭遇炸群（大量广告号进入），机器人会在短时间内执行大量踢人操作。这种高频管理操作是导致机器人被封号（尤其是1天/7天冻结）的主要原因之一。
  - **内容重复**: 短时间内发送大量完全相同的文本（如“签到成功”），容易被识别为垃圾消息。

### 1.3 自身消息管理 (Low Risk -> Improved)
- **现状**: 刚刚加入了“自身消息撤回”功能。
- **评价**: 这是一个**积极的防封特性**。定期清理机器人发送的历史消息可以减少被举报的证据留存，降低因历史言论被追溯封号的风险。

## 2. 改进建议 (Improvement Suggestions)

针对上述风险，提出以下技术改进方案：

### 2.1 增加随机延迟 (Random Jitter)
**方案**: 在发送消息前增加一个随机的等待时间（例如 800ms ~ 2500ms）。
**效果**: 模拟人类打字和网络延迟，打破“秒回”的脚本特征。

### 2.2 消息队列与流控 (Message Queue & Throttling)
**方案**: 实现一个全局消息队列。
- 将所有待发送消息放入队列。
- 消费者以固定频率（如每秒最多1-2条）从队列取出并发送。
- 对同一群组的消息进行额外的频率限制。

### 2.3 文本随机化 (Text Variation)
**方案**: 在固定回复中加入随机干扰符或表情。
- 例如：`签到成功` -> `签到成功~` / `签到成功！` / `(≧∇≦)ﾉ 签到成功`
- 效果：降低内容重复度，规避文本指纹检测。

### 2.4 管理操作缓冲 (Action Buffering)
**方案**: 对于踢人/禁言操作，不立即执行 API 调用，而是放入“执行桶”。
- 如果短时间内需要踢出 10 人，不要在 1 秒内发 10 个包，而是每隔 2-3 秒踢一个。

## 3. 已落实的改进 (Implemented Fixes)

为了立即提升防封能力，我将在代码中直接实施以下核心改进：

1.  **全局发送延迟**: 在 `src/state.ts` 的 `sendGroupMsg` 方法中强制加入 `500ms - 1500ms` 的随机延迟。
2.  **自身撤回机制**: 已在配置中支持自定义时长的自动撤回，建议设置为 1-2 分钟（60-120秒），既能让用户看清内容，又能及时销毁记录。

## 4. 运营建议 (Operational Advice)

除了代码层面的改进，建议在运营时注意：
- **不要使用新号**: 新注册的QQ号权重极低，做机器人必死。建议使用注册时长 > 3年，且有日常活跃行为（挂机、听歌、聊天）的老号。
- **分级授权**: 不要给所有群都开启“高频互动”功能（如抽奖、刷屏检测）。只在活跃且安全的群开启。
- **多号轮询**: 如果是商业化运营，建议支持多账号负载均衡（当前插件架构暂不支持，需更高层架构支持）。
