<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>插件自动更新 · 配置面板</title>
  <style>
    :root {
      --accent: #8b5cf6;
      --accentl: #a78bfa;
      --bg: #f6f8fa;
      --bgd: #0d1117;
      --card: rgba(255, 255, 255, .85);
      --cardd: rgba(22, 27, 34, .75);
      --side: #fff;
      --sided: #161b22;
      --border: #d0d7de;
      --borderd: #30363d;
      --text: #1f2328;
      --textd: #e6edf3;
      --text2: #656d76;
      --text2d: #8b949e;
      --text3: #8b949e;
      --danger: #cf222e;
      --dangerd: #f85149;
      --ease: cubic-bezier(.4, 0, .2, 1)
    }

    * {
      box-sizing: border-box;
      margin: 0
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif
    }

    body {
      background: var(--bg);
      color: var(--text);
      transition: background .3s, color .3s
    }

    .dark body,
    .dark {
      background: var(--bgd);
      color: var(--textd)
    }

    .glass {
      background: var(--card);
      backdrop-filter: blur(16px);
      border-radius: 12px;
      border: 1px solid rgba(208, 215, 222, .5);
      box-shadow: 0 1px 3px rgba(31, 35, 40, .04);
      transition: all .25s var(--ease)
    }

    .dark .glass {
      background: var(--cardd);
      border-color: var(--borderd)
    }

    .sb {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      border-radius: 10px;
      color: var(--text2);
      cursor: pointer;
      margin-bottom: 2px;
      font-size: 13px;
      font-weight: 500;
      transition: all .2s;
      user-select: none
    }

    .sb:hover {
      background: rgba(139, 92, 246, .08);
      color: var(--accent)
    }

    .sb.active {
      background: linear-gradient(135deg, var(--accentl), var(--accent));
      color: #fff;
      box-shadow: 0 2px 10px rgba(139, 92, 246, .3)
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 16px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      gap: 6px;
      font-size: 13px;
      transition: all .2s
    }

    .btn:active {
      transform: scale(.96)
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed
    }

    .btn-p {
      background: linear-gradient(135deg, var(--accentl), var(--accent));
      color: #fff;
      box-shadow: 0 2px 8px rgba(139, 92, 246, .25)
    }

    .btn-p:hover:not(:disabled) {
      box-shadow: 0 4px 14px rgba(139, 92, 246, .35);
      filter: brightness(1.05)
    }

    .btn-s {
      background: rgba(139, 92, 246, .08);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, .2)
    }

    .btn-s:hover {
      background: rgba(139, 92, 246, .15)
    }

    .btn-d {
      background: rgba(207, 34, 46, .06);
      color: var(--danger);
      border: 1px solid rgba(207, 34, 46, .15)
    }

    .btn-d:hover {
      background: rgba(207, 34, 46, .12)
    }

    .btn-w {
      background: rgba(234, 179, 8, .08);
      color: #ca8a04;
      border: 1px solid rgba(234, 179, 8, .2)
    }

    .btn-w:hover {
      background: rgba(234, 179, 8, .15)
    }

    .ipt {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 13px;
      transition: all .2s;
      color: var(--text)
    }

    .dark .ipt {
      background: rgba(22, 27, 34, .6);
      border-color: var(--borderd);
      color: var(--textd)
    }

    .ipt:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, .15)
    }

    .tgl {
      position: relative;
      width: 40px;
      height: 22px;
      background: #d0d7de;
      border-radius: 11px;
      cursor: pointer;
      transition: background .25s;
      flex-shrink: 0
    }

    .dark .tgl {
      background: #30363d
    }

    .tgl.on {
      background: linear-gradient(135deg, var(--accentl), var(--accent))
    }

    .tgl::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: transform .25s var(--ease);
      box-shadow: 0 1px 3px rgba(0, 0, 0, .12)
    }

    .tgl.on::after {
      transform: translateX(18px)
    }

    .pg {
      display: none;
      animation: fi .3s var(--ease)
    }

    .pg.active {
      display: block
    }

    @keyframes fi {
      from {
        opacity: 0;
        transform: translateY(6px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .sec-t {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-bottom: 10px
    }

    .cfg-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0
    }

    .cfg-sec {
      border-bottom: 1px solid rgba(208, 215, 222, .3);
      padding-bottom: 14px;
      margin-bottom: 14px
    }

    .dark .cfg-sec {
      border-color: rgba(48, 54, 61, .5)
    }

    .cfg-sec:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0
    }

    .toast-c {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .toast {
      padding: 10px 16px;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
      display: flex;
      align-items: center;
      gap: 8px;
      animation: si .3s ease;
      font-size: 13px;
      border: 1px solid rgba(208, 215, 222, .3)
    }

    .dark .toast {
      background: #161b22;
      border-color: var(--borderd)
    }

    @keyframes si {
      from {
        opacity: 0;
        transform: translateX(80px)
      }

      to {
        opacity: 1;
        transform: translateX(0)
      }
    }

    .scr::-webkit-scrollbar {
      width: 5px
    }

    .scr::-webkit-scrollbar-track {
      background: transparent
    }

    .scr::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, .25);
      border-radius: 3px
    }

    .sidebar {
      width: 200px;
      flex-shrink: 0;
      background: var(--side);
      border-right: 1px solid rgba(208, 215, 222, .5);
      display: flex;
      flex-direction: column;
      z-index: 10;
      transition: background .3s
    }

    .dark .sidebar {
      background: var(--sided);
      border-color: var(--borderd)
    }

    .main-area {
      flex: 1;
      overflow-y: auto;
      padding: 4px 20px 32px
    }

    .header-bar {
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 20px;
      background: rgba(246, 248, 250, .8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(208, 215, 222, .3)
    }

    .dark .header-bar {
      background: rgba(13, 17, 23, .8);
      border-color: rgba(48, 54, 61, .3)
    }

    .plugin-card {
      border: 1px solid rgba(208, 215, 222, .4);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, .4);
      transition: all .2s
    }

    .dark .plugin-card {
      border-color: var(--borderd);
      background: rgba(22, 27, 34, .3)
    }

    .plugin-card:hover {
      border-color: rgba(139, 92, 246, .3);
      box-shadow: 0 2px 8px rgba(139, 92, 246, .06)
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500
    }

    .badge-ok {
      background: rgba(139, 92, 246, .1);
      color: var(--accent)
    }

    .badge-up {
      background: rgba(234, 179, 8, .1);
      color: #eab308
    }

    .badge-ig {
      background: rgba(107, 114, 128, .1);
      color: var(--text2)
    }

    .log-c {
      max-height: 400px;
      overflow-y: auto;
      background: #0c1222;
      border-radius: 10px;
      padding: 12px;
      font-family: 'Cascadia Code', Consolas, monospace;
      font-size: 11px;
      line-height: 1.6
    }

    .log-e {
      padding: 1px 0;
      border-bottom: 1px solid rgba(255, 255, 255, .03);
      white-space: pre-wrap;
      word-break: break-all
    }

    .log-e .lt {
      color: #475569
    }

    .log-e.log-info .ll {
      color: #60a5fa
    }

    .log-e.log-debug .ll {
      color: #a78bfa
    }

    .log-e.log-warn .ll {
      color: #fbbf24
    }

    .log-e.log-error .ll {
      color: #f87171
    }

    .log-e .lm {
      color: #e2e8f0
    }

    /* 自定义确认弹窗 */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px)
    }

    .modal-overlay.show {
      display: flex
    }

    .modal {
      background: #fff;
      border-radius: 14px;
      padding: 24px;
      width: 380px;
      max-width: 90vw;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .2);
      border: 1px solid rgba(208, 215, 222, .3);
      text-align: center
    }

    .dark .modal {
      background: #161b22;
      border-color: var(--borderd)
    }

    .mirror-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border: 1px solid rgba(208, 215, 222, .3);
      border-radius: 10px;
      margin-bottom: 6px;
      transition: all .2s;
      cursor: pointer
    }

    .dark .mirror-row {
      border-color: rgba(48, 54, 61, .4)
    }

    .mirror-row:hover {
      border-color: rgba(139, 92, 246, .3);
      background: rgba(139, 92, 246, .03)
    }

    .mirror-row.selected {
      border-color: var(--accent);
      background: rgba(139, 92, 246, .06);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, .15)
    }

    .latency-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      min-width: 60px;
      text-align: center
    }

    .latency-fast {
      background: rgba(34, 197, 94, .1);
      color: #22c55e
    }

    .latency-mid {
      background: rgba(234, 179, 8, .1);
      color: #eab308
    }

    .latency-slow {
      background: rgba(249, 115, 22, .1);
      color: #f97316
    }

    .latency-fail {
      background: rgba(207, 34, 46, .08);
      color: var(--danger)
    }

    .latency-wait {
      background: rgba(107, 114, 128, .08);
      color: var(--text3)
    }
  </style>
</head>

<body>
  <div id="tc" class="toast-c"></div>

  <!-- 自定义确认弹窗（替代 confirm()） -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal">
      <div style="margin-bottom:12px"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#eab308"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3" />
          <path d="M12 9v4" />
          <path d="M12 17h.01" />
        </svg></div>
      <div id="confirm-msg" style="font-size:14px;margin-bottom:20px;line-height:1.5"></div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn btn-s" onclick="confirmResolve(false)">取消</button>
        <button class="btn btn-p" onclick="confirmResolve(true)">确认</button>
      </div>
    </div>
  </div>

  <div style="display:flex;height:100vh;overflow:hidden">
    <aside class="sidebar">
      <div style="padding:16px;display:flex;align-items:center;gap:10px">
        <div
          style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:rgba(139,92,246,.15);border-radius:12px">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
            <path d="M21 3v5h-5" />
          </svg>
        </div>
        <div>
          <h1 style="font-size:14px;font-weight:700;line-height:1.25">插件自动更新</h1>
          <p style="font-size:10px;color:var(--text3)" id="sidebar-ver">插件自动更新</p>
        </div>
      </div>
      <nav style="flex:1;padding:4px 10px;overflow-y:auto" class="scr">
        <div class="sb active" onclick="go('dashboard',this)"><svg width="16" height="16" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7" rx="1" />
            <rect x="14" y="3" width="7" height="7" rx="1" />
            <rect x="3" y="14" width="7" height="7" rx="1" />
            <rect x="14" y="14" width="7" height="7" rx="1" />
          </svg> 仪表盘</div>
        <div class="sb" onclick="go('recommend',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon
              points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
          </svg> 推荐插件</div>
        <div class="sb" onclick="go('config',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
            <circle cx="12" cy="12" r="3" />
          </svg> 基础配置</div>
        <div class="sb" onclick="go('plugins',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
            <path d="m3.3 7 8.7 5 8.7-5" />
            <path d="M12 22V12" />
          </svg> 插件列表</div>
        <div class="sb" onclick="go('mirrors',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
            <path d="M2 12h20" />
          </svg> 镜像源</div>
        <div class="sb" onclick="go('logs',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" />
            <path d="M14 2v4a2 2 0 0 0 2 2h4" />
            <path d="M10 13H8" />
            <path d="M16 17H8" />
            <path d="M16 13h-2" />
          </svg> 调试日志</div>
      </nav>
      <div
        style="padding:10px 12px;border-top:1px solid rgba(208,215,222,.3);text-align:center;font-size:10px;color:var(--text3)">
        <div style="margin-bottom:6px">by 冷曦</div>
        <div style="display:flex;justify-content:center;gap:10px">
          <a href="https://github.com/lengxi-root/napcat-plugin-lengxi" target="_blank"
            style="color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:3px">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z" />
            </svg>
            GitHub
          </a>
          <a href="https://qm.qq.com/q/oB5hdOZcuQ" target="_blank"
            style="color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:3px">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            </svg>
            交流群
          </a>
        </div>
      </div>
    </aside>

    <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
      <header class="header-bar">
        <div style="display:flex;align-items:center;gap:8px">
          <button onclick="doCheck()" class="btn btn-p" id="checkBtn"><svg width="14" height="14" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg> 检查更新</button>
          <button onclick="doRefresh()" class="btn btn-s">刷新</button>
        </div>
      </header>
      <main class="main-area scr">

        <!-- 仪表盘 -->
        <div id="pg-dashboard" class="pg active">
          <div class="glass" style="padding:20px;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                <path d="M21 3v5h-5" />
              </svg>
              <div>
                <h3 style="font-size:18px;font-weight:700">插件自动更新管理器</h3>
                <p style="font-size:12px;color:var(--text3)">自动检查并更新已安装的 NapCat 插件</p>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
              <div style="text-align:center;padding:14px 8px;border-radius:12px;background:rgba(139,92,246,.06)">
                <div style="font-size:20px;font-weight:700;color:var(--accent)" id="d-total">-</div>
                <div style="font-size:10px;color:var(--text3);margin-top:4px">已安装插件</div>
              </div>
              <div style="text-align:center;padding:14px 8px;border-radius:12px;background:rgba(234,179,8,.06)">
                <div style="font-size:20px;font-weight:700;color:#eab308" id="d-updates">-</div>
                <div style="font-size:10px;color:var(--text3);margin-top:4px">可更新</div>
              </div>
              <div style="text-align:center;padding:14px 8px;border-radius:12px;background:rgba(59,130,246,.06)">
                <div style="font-size:20px;font-weight:700;color:#3b82f6" id="d-mode">-</div>
                <div style="font-size:10px;color:var(--text3);margin-top:4px">更新模式</div>
              </div>
              <div style="text-align:center;padding:14px 8px;border-radius:12px;background:rgba(168,85,247,.06)">
                <div style="font-size:20px;font-weight:700;color:#a855f7" id="d-last">-</div>
                <div style="font-size:10px;color:var(--text3);margin-top:4px">上次检查</div>
              </div>
            </div>
          </div>
          <div class="glass" style="padding:20px" id="updates-section">
            <div class="sec-t">可更新插件</div>
            <div id="updates-list">
              <p style="color:var(--text3);font-size:13px">暂无更新，点击"检查更新"开始</p>
            </div>
          </div>
          <!-- Puppeteer 渲染服务 -->
          <div class="glass" style="padding:16px;margin-top:16px" id="card-puppeteer">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0">
                <div
                  style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:rgba(234,179,8,.12);border-radius:8px;flex-shrink:0">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="14" rx="2" />
                    <path d="M8 21h8" />
                    <path d="M12 17v4" />
                  </svg>
                </div>
                <div style="min-width:0">
                  <div style="font-size:13px;font-weight:600">Puppeteer 渲染服务 <span id="pptr-version"
                      style="font-size:11px;font-weight:400;color:var(--text3)"></span></div>
                  <div style="font-size:11px;color:var(--text3);display:flex;align-items:center;gap:6px">
                    <span id="pptr-status">检查中...</span>
                    <span>·</span>
                    <a href="https://github.com/AQiaoYo/napcat-plugin-puppeteer" target="_blank"
                      style="color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:2px"><svg
                        width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 3h6v6" />
                        <path d="M10 14 21 3" />
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                      </svg> GitHub</a>
                  </div>
                </div>
              </div>
              <button id="pptr-btn" class="btn btn-p" style="padding:5px 14px;font-size:12px" onclick="installPptr()"
                disabled>安装</button>
            </div>
          </div>
        </div>

        <!-- 推荐插件 -->
        <div id="pg-recommend" class="pg">
          <div class="glass" style="padding:20px;margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="display:flex;align-items:center;gap:12px">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                </svg>
                <div>
                  <h3 style="font-size:16px;font-weight:700">推荐插件</h3>
                  <p style="font-size:11px;color:var(--text3)" id="lengxi-update-time">来自
                    lengxi-root/napcat-plugin-lengxi</p>
                </div>
              </div>
              <button class="btn btn-s" id="lengxiRefreshBtn" onclick="loadLengxiPlugins()"><svg width="14" height="14"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                  <path d="M21 3v5h-5" />
                </svg> 刷新</button>
            </div>
            <div id="lengxi-plugins-list">
              <p style="color:var(--text3);font-size:13px">加载中...</p>
            </div>
          </div>
          <div class="glass" style="padding:16px">
            <div style="display:flex;align-items:flex-start;gap:10px">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;margin-top:2px">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
              </svg>
              <div style="font-size:12px;color:var(--text2);line-height:1.8">
                <div style="font-weight:600;font-size:13px;color:var(--text);margin-bottom:4px">⚠️ 安全声明</div>
                <p style="margin:0 0 6px">本项目全部插件<span
                    style="color:var(--accent);font-weight:600">不包含任何远程操控命令、后门程序或恶意代码</span>，全部源码明文开源。</p>
                <p style="margin:0 0 6px">当你每次更新插件时，请阅读最新的 <a
                    href="https://github.com/lengxi-root/napcat-plugin-lengxi/commits/main" target="_blank"
                    style="color:var(--accent);text-decoration:none;font-weight:500">Commits</a>，更新即代表你同意该版本的功能变更，否则请立即停止更新。
                </p>
                <p style="margin:0 0 6px">插件更新的任何功能皆为插件的一部分。如果你不信任该项目库，请立即卸载相关全部插件。</p>
                <p style="margin:0;display:flex;align-items:center;gap:6px">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                  </svg>
                  交流群：<a href="https://qm.qq.com/q/oB5hdOZcuQ" target="_blank"
                    style="color:var(--accent);text-decoration:none;font-weight:500">1085402468</a>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- 基础配置 -->
        <div id="pg-config" class="pg">
          <div class="glass" style="padding:20px">
            <div class="sec-t">更新设置</div>
            <div class="cfg-sec">
              <div class="cfg-row">
                <div>
                  <div style="font-size:14px;font-weight:500">更新模式</div>
                  <div style="font-size:11px;color:var(--text3)">auto=自动更新, notify=仅通知</div>
                </div>
                <select id="cfg-mode" class="ipt" style="width:140px">
                  <option value="notify">仅通知</option>
                  <option value="auto">自动更新</option>
                </select>
              </div>
            </div>
            <div class="cfg-sec">
              <div class="cfg-row">
                <div>
                  <div style="font-size:14px;font-weight:500">定时检查</div>
                  <div style="font-size:11px;color:var(--text3)">启用后按间隔自动检查</div>
                </div>
                <div id="cfg-schedule" class="tgl" onclick="toggleTgl(this)"></div>
              </div>
            </div>
            <div class="cfg-sec">
              <div class="cfg-row">
                <div>
                  <div style="font-size:14px;font-weight:500">检查间隔（分钟）</div>
                  <div style="font-size:11px;color:var(--text3)">最小 1 分钟</div>
                </div>
                <input type="number" id="cfg-interval" class="ipt" style="width:100px" min="1" value="5" />
              </div>
            </div>
            <div class="cfg-sec">
              <div>
                <div style="font-size:14px;font-weight:500;margin-bottom:6px">主人QQ号</div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:6px">逗号分隔，拥有指令操作权限</div>
              </div>
              <input type="text" id="cfg-owners" class="ipt" placeholder="123456,789012" />
            </div>
            <div class="cfg-sec">
              <div>
                <div style="font-size:14px;font-weight:500;margin-bottom:6px">通知群号</div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:6px">逗号分隔，更新通知推送到这些群</div>
              </div>
              <input type="text" id="cfg-groups" class="ipt" placeholder="111222,333444" />
            </div>
            <div class="cfg-sec">
              <div>
                <div style="font-size:14px;font-weight:500;margin-bottom:6px">自动更新插件列表</div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:6px">勾选需要自动更新的插件，不勾选=全部自动更新（仅 auto 模式生效）
                </div>
              </div>
              <div id="cfg-autoupdate-list"
                style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:6px">
                <div style="color:var(--text3);font-size:12px;padding:4px 8px">加载中...</div>
              </div>
            </div>
            <div class="cfg-sec">
              <div class="cfg-row">
                <div>
                  <div style="font-size:14px;font-weight:500">调试模式</div>
                </div>
                <div id="cfg-debug" class="tgl" onclick="toggleTgl(this)"></div>
              </div>
            </div>
            <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
              <button class="btn btn-p" onclick="saveConfig()"><svg width="14" height="14" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path
                    d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" />
                  <path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7" />
                  <path d="M7 3v4a1 1 0 0 0 1 1h7" />
                </svg> 保存配置</button>
            </div>
          </div>
        </div>

        <!-- 插件列表 -->
        <div id="pg-plugins" class="pg">
          <div class="glass" style="padding:20px">
            <div class="sec-t">已安装插件</div>
            <div id="plugins-list">
              <p style="color:var(--text3);font-size:13px">加载中...</p>
            </div>
          </div>
        </div>

        <!-- 镜像源 -->
        <div id="pg-mirrors" class="pg">
          <div class="glass" style="padding:20px;margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div class="sec-t" style="margin-bottom:0">商店索引镜像 (Raw)</div>
              <button class="btn btn-s" id="pingRawBtn" onclick="pingRaw()"><svg width="14" height="14"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" />
                </svg> 测速</button>
            </div>
            <div id="raw-mirror-list">
              <p style="color:var(--text3);font-size:13px">点击"测速"检测延迟</p>
            </div>
          </div>
          <div class="glass" style="padding:20px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div class="sec-t" style="margin-bottom:0">插件下载镜像 (Release)</div>
              <button class="btn btn-s" id="pingDlBtn" onclick="pingDownload()"><svg width="14" height="14"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" />
                </svg> 测速</button>
            </div>
            <div id="dl-mirror-list">
              <p style="color:var(--text3);font-size:13px">点击"测速"检测延迟</p>
            </div>
          </div>
        </div>

        <!-- 日志 -->
        <div id="pg-logs" class="pg">
          <div class="glass" style="padding:20px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div class="sec-t" style="margin-bottom:0">调试日志</div>
              <div style="display:flex;gap:6px">
                <button class="btn btn-s" onclick="loadLogs()">刷新</button>
                <button class="btn btn-d" onclick="clearLogs()">清空</button>
              </div>
            </div>
            <div id="log-container" class="log-c">
              <div style="color:#475569">加载中...</div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <script>
    const BASE = window.location.origin + '/plugin/napcat-plugin-autoupdate/api';
    let config = {};
    let updatesMap = {}; // pluginName -> UpdateInfo, 用于插件列表页显示更新按钮
    let confirmResolveFn = null;
    let darkMode = window.matchMedia('(prefers-color-scheme:dark)').matches;
    if (darkMode) document.documentElement.classList.add('dark');

    // ===== 自定义确认弹窗（替代 confirm()，sandbox 环境不支持 confirm） =====
    function showConfirm (msg) {
      return new Promise(resolve => {
        confirmResolveFn = resolve;
        document.getElementById('confirm-msg').textContent = msg;
        document.getElementById('confirmModal').classList.add('show');
      });
    }
    function confirmResolve (val) {
      document.getElementById('confirmModal').classList.remove('show');
      if (confirmResolveFn) { confirmResolveFn(val); confirmResolveFn = null; }
    }

    // SVG icon helpers
    const SVG = {
      info: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
      success: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>',
      error: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>',
      warn: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
      search: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
      update: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 14 4-4-4-4"/><path d="M3 18v-3a4 4 0 0 1 4-4h10"/></svg>',
      updateAll: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>',
      link: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>',
      bolt: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
      refresh: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>',
      loader: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>',
    };

    function toast (msg, type = 'info') {
      const tc = document.getElementById('tc');
      const el = document.createElement('div');
      el.className = 'toast';
      el.innerHTML = `<span>${SVG[type] || SVG.info}</span><span>${msg}</span>`;
      tc.appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
    }

    function go (page, el) {
      document.querySelectorAll('.pg').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.sb').forEach(s => s.classList.remove('active'));
      const pg = document.getElementById('pg-' + page);
      if (pg) pg.classList.add('active');
      if (el) el.classList.add('active');
      if (page === 'plugins') loadPlugins();
      if (page === 'logs') loadLogs();
      if (page === 'mirrors') loadMirrorState();
      if (page === 'recommend') loadLengxiPlugins();
    }

    function toggleTgl (el) { el.classList.toggle('on'); }

    async function api (path, method = 'GET', body = null) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(BASE + path, opts);
      return res.json();
    }

    async function loadConfig () {
      const r = await api('/config');
      if (!r.success) return;
      config = r.config;
      if (r.version) { document.getElementById('sidebar-ver').textContent = 'v' + r.version; }
      document.getElementById('cfg-mode').value = config.updateMode || 'notify';
      const schEl = document.getElementById('cfg-schedule');
      if (config.enableSchedule) schEl.classList.add('on'); else schEl.classList.remove('on');
      document.getElementById('cfg-interval').value = config.checkInterval || 5;
      document.getElementById('cfg-owners').value = (config.owners || []).join(',');
      document.getElementById('cfg-groups').value = (config.notifyGroups || []).join(',');
      renderAutoUpdateList();
      const dbgEl = document.getElementById('cfg-debug');
      if (config.debug) dbgEl.classList.add('on'); else dbgEl.classList.remove('on');
      document.getElementById('d-mode').textContent = config.updateMode === 'auto' ? '自动' : '通知';
    }

    async function saveConfig () {
      const body = {
        updateMode: document.getElementById('cfg-mode').value,
        enableSchedule: document.getElementById('cfg-schedule').classList.contains('on'),
        checkInterval: parseInt(document.getElementById('cfg-interval').value) || 5,
        debug: document.getElementById('cfg-debug').classList.contains('on'),
        owners: document.getElementById('cfg-owners').value.split(',').map(s => s.trim()).filter(Boolean),
        notifyGroups: document.getElementById('cfg-groups').value.split(',').map(s => s.trim()).filter(Boolean),
        autoUpdatePlugins: Array.from(document.querySelectorAll('#cfg-autoupdate-list input[type=checkbox]:checked')).map(cb => cb.value),
      };
      const r = await api('/config', 'POST', body);
      toast(r.success ? '配置已保存' : '保存失败', r.success ? 'success' : 'error');
      if (r.success) loadConfig();
    }

    async function renderAutoUpdateList () {
      const el = document.getElementById('cfg-autoupdate-list');
      const r = await api('/plugins');
      if (!r.success || !r.data.length) {
        el.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:4px 8px">暂无可选插件</div>';
        return;
      }
      const selected = new Set(config.autoUpdatePlugins || []);
      el.innerHTML = r.data.map(p => {
        const checked = selected.has(p.name) ? 'checked' : '';
        return `<label style="display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;cursor:pointer;font-size:13px;transition:background .15s" onmouseover="this.style.background='rgba(139,92,246,.06)'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" value="${p.name}" ${checked} style="accent-color:#8b5cf6;width:15px;height:15px;cursor:pointer">
          <span style="flex:1">${p.displayName}</span>
          <span style="font-size:11px;color:var(--text3)">${p.name}</span>
        </label>`;
      }).join('');
    }

    // SVG for small refresh icon on plugin cards
    const SVG_REFRESH_SM = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>';

    let lastCheckTime = 0; // 记录上次检查时间

    async function loadPlugins () {
      const r = await api('/plugins');
      const el = document.getElementById('plugins-list');
      if (!r.success || !r.data.length) { el.innerHTML = '<p style="color:var(--text3);font-size:13px">未扫描到插件</p>'; return; }
      document.getElementById('d-total').textContent = r.data.length;
      const ignored = new Set(config.ignoredPlugins || []);
      const neverChecked = lastCheckTime === 0;
      el.innerHTML = r.data.map(p => {
        const update = updatesMap[p.name];
        const hasUpdate = !!update;
        let badgeHtml, actionHtml;
        if (ignored.has(p.name)) {
          badgeHtml = `<span class="badge badge-ig" style="margin-left:8px">已忽略</span>`;
          actionHtml = '';
        } else if (hasUpdate) {
          badgeHtml = `<span class="badge badge-up" style="margin-left:8px">${p.currentVersion} → ${update.latestVersion}</span>`;
          actionHtml = `<button class="btn btn-w" style="padding:4px 12px;font-size:12px" onclick="doUpdate('${p.name}')">${SVG.update} 更新</button>`;
        } else if (neverChecked) {
          badgeHtml = `<span class="badge badge-ig" style="margin-left:8px">v${p.currentVersion}</span>`;
          actionHtml = `<span style="font-size:11px;color:var(--text3)">未检查</span>`;
        } else {
          badgeHtml = `<span class="badge badge-ok" style="margin-left:8px">v${p.currentVersion}</span>`;
          actionHtml = `<span style="font-size:11px;color:var(--accent)">✓ 最新</span>`;
        }
        const refreshBtn = `<button class="btn btn-s" style="padding:3px 8px;font-size:11px" onclick="doCheckSingle('${p.name}',this)" title="检查此插件更新">${SVG_REFRESH_SM}</button>`;
        return `
          <div class="plugin-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="flex:1;min-width:0">
                <span style="font-size:14px;font-weight:600">${p.displayName}</span>
                ${badgeHtml}
              </div>
              <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
                ${actionHtml}
                ${refreshBtn}
              </div>
            </div>
            <div style="font-size:11px;color:var(--text3);margin-top:4px">${p.name}</div>
          </div>`;
      }).join('');
    }

    async function loadUpdates () {
      const r = await api('/updates');
      const el = document.getElementById('updates-list');
      const updates = r.data || [];
      document.getElementById('d-updates').textContent = updates.length;
      // 记录上次检查时间
      lastCheckTime = r.lastCheck || 0;
      // 构建 map 供插件列表页使用
      updatesMap = {};
      updates.forEach(u => { updatesMap[u.pluginName] = u; });

      // 更新仪表盘"上次检查"
      document.getElementById('d-last').textContent = lastCheckTime ? new Date(lastCheckTime).toLocaleTimeString('zh-CN') : '未检查';

      if (updates.length > 0) {
        el.innerHTML = updates.map(u => `
          <div class="plugin-card" style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <span style="font-size:14px;font-weight:600">${u.displayName}</span>
              <span class="badge badge-up" style="margin-left:8px">${u.currentVersion} → ${u.latestVersion}</span>
              ${u.publishedAt ? `<span style="font-size:11px;color:var(--text3);margin-left:8px">${new Date(u.publishedAt).toLocaleDateString('zh-CN')}</span>` : ''}
            </div>
            <button class="btn btn-p" onclick="doUpdate('${u.pluginName}')">${SVG.update} 更新</button>
          </div>
        `).join('') + `<div style="margin-top:12px;text-align:right"><button class="btn btn-p" onclick="doUpdate('__all__')">${SVG.updateAll} 全部更新</button></div>`;
      } else {
        el.innerHTML = '<p style="color:var(--text3);font-size:13px">所有插件均为最新版本</p>';
      }
    }

    async function doCheck () {
      const btn = document.getElementById('checkBtn');
      btn.disabled = true; btn.innerHTML = SVG.loader + ' 检查中...';
      try {
        const r = await api('/check');
        if (r.success) {
          toast(`检查完成，发现 ${r.data.length} 个可更新`, r.data.length > 0 ? 'warn' : 'success');
          await loadUpdates();
          loadPlugins();
        } else {
          toast('检查失败: ' + r.error, 'error');
        }
      } catch (e) { toast('请求失败', 'error'); }
      btn.disabled = false; btn.innerHTML = SVG.search + ' 检查更新';
    }

    async function doUpdate (name) {
      const msg = name === '__all__' ? '确认更新所有插件？更新后可能需要重启 NapCat。' : `确认更新 ${name}？更新后可能需要重启 NapCat。`;
      const ok = await showConfirm(msg);
      if (!ok) return;
      toast('正在更新...', 'info');
      const r = await api('/update', 'POST', { pluginName: name });
      if (r.success) {
        toast('更新完成，可能需要重启 NapCat 生效', 'success');
        await loadUpdates();
        loadPlugins();
      } else {
        toast('更新失败: ' + (r.error || '未知错误'), 'error');
      }
    }

    async function doCheckSingle (pluginName, btnEl) {
      if (btnEl) { btnEl.disabled = true; btnEl.innerHTML = SVG.loader; }
      try {
        const r = await api('/check/' + encodeURIComponent(pluginName));
        if (r.success) {
          lastCheckTime = r.lastCheck || lastCheckTime || Date.now();
          if (r.data) {
            updatesMap[pluginName] = r.data;
            toast(`${pluginName} 有新版本: ${r.data.latestVersion}`, 'warn');
          } else {
            delete updatesMap[pluginName];
            toast(`${pluginName} 已是最新`, 'success');
          }
          loadPlugins();
          loadUpdates();
        } else {
          toast('检查失败: ' + (r.error || ''), 'error');
        }
      } catch { toast('请求失败', 'error'); }
      if (btnEl) { btnEl.disabled = false; btnEl.innerHTML = SVG_REFRESH_SM; }
    }

    async function loadLogs () {
      const r = await api('/logs');
      const el = document.getElementById('log-container');
      if (!r.success || !r.data.length) { el.innerHTML = '<div style="color:#475569">暂无日志</div>'; return; }
      el.innerHTML = r.data.map(l => {
        const t = new Date(l.time).toLocaleTimeString('zh-CN');
        return `<div class="log-e log-${l.level}"><span class="lt">${t}</span> <span class="ll">[${l.level.toUpperCase()}]</span> <span class="lm">${l.msg}</span></div>`;
      }).join('');
      el.scrollTop = el.scrollHeight;
    }

    async function clearLogs () {
      await api('/logs/clear', 'POST');
      loadLogs();
      toast('日志已清空', 'success');
    }

    function doRefresh () { loadConfig(); loadUpdates().then(() => loadPlugins()); toast('已刷新', 'info'); }

    // ===== 镜像管理 =====
    let mirrorState = { selectedRaw: '', selectedDownload: '' };

    function latencyTag (ms, ok) {
      if (!ok || ms < 0) return '<span class="latency-tag latency-fail">超时</span>';
      if (ms < 500) return `<span class="latency-tag latency-fast">${ms}ms</span>`;
      if (ms < 2000) return `<span class="latency-tag latency-mid">${ms}ms</span>`;
      return `<span class="latency-tag latency-slow">${ms}ms</span>`;
    }

    function renderMirrorList (containerId, results, type, selectedUrl) {
      const el = document.getElementById(containerId);
      // 增加"自动"选项
      let html = `<div class="mirror-row${!selectedUrl ? ' selected' : ''}" onclick="selectMirror('${type}','')">
        <div>
          <div style="font-size:13px;font-weight:500">${SVG.refresh} 自动选择</div>
          <div style="font-size:11px;color:var(--text3)">按顺序尝试所有镜像</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${!selectedUrl ? '<span style="font-size:11px;color:var(--accent);font-weight:600">✓ 当前</span>' : ''}
        </div>
      </div>`;
      html += results.map(r => {
        const isSel = r.url === selectedUrl;
        return `<div class="mirror-row${isSel ? ' selected' : ''}" onclick="selectMirror('${type}','${r.url.replace(/'/g, "\\'")}')">
          <div style="flex:1;min-width:0">
            <div style="font-size:13px;font-weight:500">${r.label}</div>
            <div style="font-size:11px;color:var(--text3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.url || '(直连)'}</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            ${latencyTag(r.latency, r.ok)}
            ${isSel ? '<span style="font-size:11px;color:var(--accent);font-weight:600">✓ 当前</span>' : ''}
          </div>
        </div>`;
      }).join('');
      el.innerHTML = html;
    }

    async function pingRaw () {
      const btn = document.getElementById('pingRawBtn');
      btn.disabled = true; btn.innerHTML = SVG.loader + ' 测速中...';
      document.getElementById('raw-mirror-list').innerHTML = '<p style="color:var(--text3);font-size:13px">正在并行测速，请稍候...</p>';
      try {
        const r = await api('/mirrors/ping/raw');
        if (r.success) {
          renderMirrorList('raw-mirror-list', r.data, 'raw', mirrorState.selectedRaw);
          toast('Raw 镜像测速完成', 'success');
        } else { toast('测速失败', 'error'); }
      } catch { toast('请求失败', 'error'); }
      btn.disabled = false; btn.innerHTML = SVG.bolt + ' 测速';
    }

    async function pingDownload () {
      const btn = document.getElementById('pingDlBtn');
      btn.disabled = true; btn.innerHTML = SVG.loader + ' 测速中...';
      document.getElementById('dl-mirror-list').innerHTML = '<p style="color:var(--text3);font-size:13px">正在并行测速，请稍候...</p>';
      try {
        const r = await api('/mirrors/ping/download');
        if (r.success) {
          renderMirrorList('dl-mirror-list', r.data, 'download', mirrorState.selectedDownload);
          toast('下载镜像测速完成', 'success');
        } else { toast('测速失败', 'error'); }
      } catch { toast('请求失败', 'error'); }
      btn.disabled = false; btn.innerHTML = SVG.bolt + ' 测速';
    }

    async function selectMirror (type, mirror) {
      const r = await api('/mirrors/select', 'POST', { type, mirror });
      if (r.success) {
        if (type === 'raw') mirrorState.selectedRaw = mirror;
        else mirrorState.selectedDownload = mirror;
        toast(`已切换${type === 'raw' ? '索引' : '下载'}镜像: ${mirror || '自动'}`, 'success');
        // 刷新列表高亮
        const containerId = type === 'raw' ? 'raw-mirror-list' : 'dl-mirror-list';
        document.querySelectorAll(`#${containerId} .mirror-row`).forEach(row => {
          const onclick = row.getAttribute('onclick') || '';
          const match = onclick.match(/selectMirror\('[^']+','([^']*)'\)/);
          const rowMirror = match ? match[1] : '';
          row.classList.toggle('selected', rowMirror === mirror);
        });
      } else { toast('切换失败', 'error'); }
    }

    async function loadMirrorState () {
      const r = await api('/mirrors');
      if (r.success) {
        mirrorState.selectedRaw = r.selectedRaw || '';
        mirrorState.selectedDownload = r.selectedDownload || '';
      }
    }

    // ===== 插件安装 =====
    const PPTR_REPO = 'AQiaoYo/napcat-plugin-puppeteer';

    async function checkPptr () {
      const verEl = document.getElementById('pptr-version');
      const statusEl = document.getElementById('pptr-status');
      const btnEl = document.getElementById('pptr-btn');
      try {
        const r = await api('/github/check/AQiaoYo/napcat-plugin-puppeteer');
        const remote = r.success ? r.data : null;
        const local = r.success ? r.installed : null;

        verEl.textContent = remote ? 'v' + remote.version : '';

        if (local) {
          statusEl.innerHTML = '<span style="color:var(--accent)">✓ 已安装 v' + local.version + '</span>';
          if (remote && remote.version !== local.version) {
            btnEl.disabled = false;
            btnEl.innerHTML = '更新';
            btnEl.className = 'btn btn-w';
            btnEl.style.cssText = 'padding:5px 14px;font-size:12px';
          } else {
            btnEl.disabled = false;
            btnEl.innerHTML = '重新安装';
            btnEl.className = 'btn btn-s';
            btnEl.style.cssText = 'padding:5px 14px;font-size:12px';
          }
        } else {
          statusEl.innerHTML = '未安装';
          btnEl.disabled = false;
          btnEl.innerHTML = '安装';
          btnEl.className = 'btn btn-p';
          btnEl.style.cssText = 'padding:5px 14px;font-size:12px';
        }
      } catch {
        statusEl.innerHTML = '未安装';
        btnEl.disabled = false;
        btnEl.innerHTML = '安装';
        btnEl.className = 'btn btn-p';
        btnEl.style.cssText = 'padding:5px 14px;font-size:12px';
      }
    }

    async function installPptr () {
      const btnEl = document.getElementById('pptr-btn');
      btnEl.disabled = true;
      btnEl.innerHTML = '安装中...';
      try {
        const r = await api('/github/install', 'POST', { repo: PPTR_REPO });
        if (r.success) {
          toast('Puppeteer 渲染服务安装成功' + (r.version ? ' v' + r.version : ''), 'success');
          checkPptr();
        } else {
          toast('安装失败: ' + (r.error || '未知错误'), 'error');
          btnEl.disabled = false;
          btnEl.innerHTML = '重试';
          btnEl.className = 'btn btn-d';
        }
      } catch (e) {
        toast('请求失败: ' + e, 'error');
        btnEl.disabled = false;
      }
    }

    // ===== Lengxi 推荐插件 =====
    async function loadLengxiPlugins () {
      const el = document.getElementById('lengxi-plugins-list');
      const btn = document.getElementById('lengxiRefreshBtn');
      btn.disabled = true; btn.innerHTML = SVG.loader + ' 加载中...';
      el.innerHTML = '<p style="color:var(--text3);font-size:13px">正在获取插件列表...</p>';
      try {
        const r = await api('/lengxi/plugins');
        if (!r.success) { el.innerHTML = `<p style="color:var(--danger);font-size:13px">获取失败: ${r.error}</p>`; return; }
        if (!r.data || r.data.length === 0) { el.innerHTML = '<p style="color:var(--text3);font-size:13px">暂无推荐插件</p>'; return; }
        if (r.updateTime) {
          document.getElementById('lengxi-update-time').textContent = '更新于 ' + new Date(r.updateTime).toLocaleString('zh-CN');
        }
        el.innerHTML = r.data.map(p => {
          const tagsHtml = (p.tags || []).map(t => `<span style="display:inline-block;padding:1px 6px;border-radius:8px;font-size:10px;background:rgba(139,92,246,.08);color:var(--accent);margin-right:4px">${t}</span>`).join('');
          let statusHtml, actionHtml;
          if (p.installed && p.hasUpdate) {
            statusHtml = `<span class="badge badge-up">v${p.installedVersion} → v${p.version}</span>`;
            actionHtml = `<button class="btn btn-w" style="padding:4px 14px;font-size:12px" onclick="doLengxiInstall('${p.id}',this)">更新</button>`;
          } else if (p.installed) {
            statusHtml = `<span class="badge badge-ok">v${p.installedVersion} ✓ 已安装</span>`;
            actionHtml = `<button class="btn btn-s" style="padding:4px 14px;font-size:12px" onclick="doLengxiInstall('${p.id}',this)">重新安装</button>`;
          } else {
            statusHtml = `<span style="font-size:11px;color:var(--text3)">v${p.version}</span>`;
            actionHtml = `<button class="btn btn-p" style="padding:4px 14px;font-size:12px" onclick="doLengxiInstall('${p.id}',this)">安装</button>`;
          }
          return `<div class="plugin-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="flex:1;min-width:0">
                <span style="font-size:14px;font-weight:600">${p.name}</span>
                <span style="margin-left:8px">${statusHtml}</span>
              </div>
              <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
                ${actionHtml}
              </div>
            </div>
            <div style="font-size:12px;color:var(--text2);margin-top:6px">${p.description || '暂无描述'}</div>
            <div style="margin-top:6px;display:flex;align-items:center;gap:8px">
              ${tagsHtml}
              ${p.author ? `<span style="font-size:10px;color:var(--text3)">by ${p.author}</span>` : ''}
            </div>
          </div>`;
        }).join('');
      } catch (e) {
        el.innerHTML = `<p style="color:var(--danger);font-size:13px">请求失败: ${e}</p>`;
      } finally {
        btn.disabled = false; btn.innerHTML = SVG.refresh + ' 刷新';
      }
    }

    async function doLengxiInstall (pluginId, btnEl) {
      const ok = await showConfirm(`确认安装/更新 ${pluginId}？安装后可能需要重启 NapCat。`);
      if (!ok) return;
      if (btnEl) { btnEl.disabled = true; btnEl.innerHTML = SVG.loader + ' 安装中...'; }
      try {
        const r = await api('/lengxi/install', 'POST', { pluginId });
        if (r.success) {
          toast(`${pluginId} 安装成功`, 'success');
          loadLengxiPlugins();
        } else {
          toast('安装失败: ' + (r.error || '未知错误'), 'error');
          if (btnEl) { btnEl.disabled = false; btnEl.innerHTML = '重试'; }
        }
      } catch (e) {
        toast('请求失败: ' + e, 'error');
        if (btnEl) { btnEl.disabled = false; btnEl.innerHTML = '重试'; }
      }
    }

    // 初始化
    loadConfig().then(() => loadUpdates()).then(() => { loadPlugins(); checkPptr(); });
  </script>
</body>

</html>