<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ä¸‰è§’æ´²è¡ŒåŠ¨ Â· é…ç½®é¢æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#F97316',
            brand: {
              orange: '#F97316',
              dark: '#2B343D',
              darker: '#18191C',
            }
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      transition: all 0.3s var(--ease-smooth);
    }

    .dark .glass-card {
      background: rgba(42, 43, 46, 0.8);
      border-color: rgba(255, 255, 255, 0.05);
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      color: #4b5563;
      transition: all 0.2s var(--ease-smooth);
      cursor: pointer;
      margin-bottom: 2px;
      font-size: 14px;
    }

    .dark .sidebar-item {
      color: #9ca3af;
    }

    .sidebar-item:hover {
      background: rgba(249, 115, 22, 0.1);
      color: #F97316;
    }

    .sidebar-item.active {
      background: #F97316;
      color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s var(--ease-spring);
      border: none;
      gap: 8px;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn-primary {
      background: #F97316;
      color: white;
    }

    .btn-primary:hover {
      background: #EA580C;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
    }

    .btn-secondary {
      background: #374151;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .input-field {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: white;
      transition: all 0.2s;
    }

    .dark .input-field {
      background: #1f2937;
      border-color: #374151;
      color: white;
    }

    .input-field:focus {
      outline: none;
      border-color: #F97316;
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
    }

    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .toggle.active {
      background: #F97316;
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .toggle.active::after {
      transform: translateX(20px);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.connected {
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
      background: #10b981;
    }

    .status-dot.disconnected {
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
      background: #ef4444;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .page-content {
      display: none;
      animation: fadeIn 0.4s var(--ease-spring);
    }

    .page-content.active {
      display: block;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }

    .dark .toast {
      background: #2a2b2e;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }

    .config-section {
      border-bottom: 1px solid rgba(156, 163, 175, 0.2);
      padding-bottom: 16px;
      margin-bottom: 16px;
    }

    .config-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .config-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
    }

    .config-row-expand {
      margin-top: 12px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 8px;
    }

    .dark .config-row-expand {
      background: rgba(255, 255, 255, 0.03);
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #CEB78B;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    /* è°ƒè¯•æ—¥å¿—æ ·å¼ */
    .log-entry {
      padding: 4px 8px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      white-space: pre-wrap;
      word-break: break-all;
    }

    .dark .log-entry {
      border-bottom-color: rgba(255, 255, 255, 0.04);
    }

    .log-entry:hover {
      background: rgba(249, 115, 22, 0.05);
    }

    .log-entry.level-error {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }

    .log-entry.level-warn {
      color: #f59e0b;
    }

    .log-entry.level-info {
      color: #6b7280;
    }

    .dark .log-entry.level-info {
      color: #9ca3af;
    }

    .log-entry.level-debug {
      color: #8b5cf6;
    }

    .log-entry.level-api {
      color: #06b6d4;
    }

    .log-time {
      color: #9ca3af;
      margin-right: 8px;
      user-select: none;
    }

    .log-level {
      display: inline-block;
      width: 44px;
      font-weight: 600;
      text-transform: uppercase;
      user-select: none;
    }

    .log-api-detail {
      margin-top: 4px;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .dark .log-api-detail {
      background: rgba(255, 255, 255, 0.03);
    }

    .log-api-detail summary {
      color: #F97316;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }

    .log-api-section {
      margin-top: 4px;
    }

    .log-api-section-title {
      color: #F97316;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .log-api-content {
      color: #6b7280;
      max-height: 200px;
      overflow-y: auto;
    }

    .dark .log-api-content {
      color: #9ca3af;
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-[#18191C] text-gray-800 dark:text-gray-200 transition-colors duration-300">
  <div id="toast-container" class="toast-container"></div>

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside
      class="w-52 flex-shrink-0 bg-white dark:bg-[#202124] border-r border-gray-200 dark:border-gray-800 flex flex-col z-10 transition-colors duration-300">
      <div class="p-4 flex items-center gap-3">
        <div class="p-2 bg-orange-100 dark:bg-orange-900/30 rounded-lg text-primary text-xl">ğŸ®</div>
        <div>
          <h1 class="font-bold text-base leading-tight">ä¸‰è§’æ´²è¡ŒåŠ¨</h1>
          <p class="text-xs text-gray-400">Delta Force</p>
        </div>
      </div>

      <nav class="flex-1 px-3 py-2 overflow-y-auto custom-scrollbar">
        <div class="sidebar-item active" onclick="switchPage('status', this)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          <span>è¿è¡ŒçŠ¶æ€</span>
        </div>
        <div class="sidebar-item" onclick="switchPage('api', this)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
          </svg>
          <span>API é…ç½®</span>
        </div>
        <div class="sidebar-item" onclick="switchPage('push', this)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span>å®šæ—¶æ¨é€</span>
        </div>
        <div class="sidebar-item" onclick="switchPage('tts', this)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
          </svg>
          <span>TTS è¯­éŸ³</span>
        </div>
        <div class="sidebar-item" onclick="switchPage('help', this)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <span>å¸®åŠ©è®¾ç½®</span>
        </div>
        <div class="sidebar-item" onclick="switchPage('debug', this)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 20h.01"></path>
            <path d="M8 16l-2 2"></path>
            <path d="M16 16l2 2"></path>
            <path d="M12 12v.01"></path>
            <path d="M8 8l-2-2"></path>
            <path d="M16 8l2-2"></path>
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2"></path>
            <path d="M12 20v2"></path>
            <path d="M2 12h2"></path>
            <path d="M20 12h2"></path>
          </svg>
          <span>è°ƒè¯•æ—¥å¿—</span>
        </div>
      </nav>

      <div class="p-3 border-t border-gray-200 dark:border-gray-800 flex flex-col items-center gap-1.5">
        <a href="https://github.com/lengxi-root/napcat-plugin-lengxi" target="_blank"
          class="flex items-center gap-1 text-[10px] text-gray-400 hover:text-primary transition-colors"
          style="text-decoration:none">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z" />
          </svg>
          GitHub
        </a>
        <a href="https://qm.qq.com/q/oB5hdOZcuQ" target="_blank"
          class="flex items-center gap-1 text-[10px] text-gray-400 hover:text-primary transition-colors"
          style="text-decoration:none">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
          </svg>
          äº¤æµç¾¤
        </a>
        <div class="text-[10px] text-gray-400">by å†·æ›¦</div>
      </div>
    </aside>

    <!-- Main Content -->
    <div
      class="flex-1 flex flex-col overflow-hidden bg-gray-50 dark:bg-[#18191C] relative transition-colors duration-300">
      <main id="mainContent" class="flex-1 overflow-y-auto h-full relative custom-scrollbar">
        <header
          class="sticky top-0 z-20 flex justify-end items-center px-4 py-3 md:px-8 md:py-4 bg-gray-50/80 dark:bg-[#18191C]/80 backdrop-blur-md border-b border-transparent">
          <div class="flex items-center gap-2">
            <button id="btnResetHelp" onclick="resetHelpList()"
              class="btn text-xs px-3 py-2 text-orange-600 hover:bg-orange-50 dark:hover:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg"
              style="display:none;">
              æ¢å¤èœå•
            </button>
            <button id="btnStyleConfig" onclick="openStyleConfigModal()"
              class="btn text-xs px-3 py-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg"
              style="display:none;">
              ğŸ¨ æ ·å¼
            </button>
            <button onclick="saveConfig()" class="btn btn-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              ä¿å­˜é…ç½®
            </button>
            <div
              class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-[#202124] rounded-full shadow-sm border border-gray-100 dark:border-gray-800">
              <div id="statusDot" class="status-dot disconnected"></div>
              <span class="text-sm font-medium" id="statusText">æ£€æµ‹ä¸­...</span>
            </div>
          </div>
        </header>

        <div class="px-4 md:px-8 pb-8">
          <!-- Page: Status -->
          <div id="page-status" class="page-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div class="glass-card p-6">
                <div class="text-gray-500 text-sm mb-2">æ’ä»¶ç‰ˆæœ¬</div>
                <div class="text-2xl font-bold text-primary" id="statVersion">v1.0.0</div>
              </div>
              <div class="glass-card p-6">
                <div class="text-gray-500 text-sm mb-2">Puppeteer</div>
                <div class="text-2xl font-bold" id="statPuppeteer"><span class="text-red-500">æœªè¿æ¥</span></div>
              </div>
              <div class="glass-card p-6">
                <div class="text-gray-500 text-sm mb-2">API çŠ¶æ€</div>
                <div class="text-2xl font-bold" id="statApi"><span class="text-gray-400">-</span></div>
              </div>
              <div class="glass-card p-6">
                <div class="text-gray-500 text-sm mb-2">è¿è¡Œæ¨¡å¼</div>
                <div class="text-xl font-bold text-blue-500" id="statMode">Auto</div>
              </div>
            </div>

            <!-- Puppeteer æœªè¿æ¥æç¤º -->
            <div id="puppeteerWarning" class="glass-card p-6 mb-6"
              style="display: none; background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3);">
              <div class="flex items-start gap-4">
                <div class="text-red-500 text-2xl flex-shrink-0">âš ï¸</div>
                <div class="flex-1">
                  <h3 class="font-bold text-lg text-red-600 dark:text-red-400 mb-2">Puppeteer æ¸²æŸ“æœåŠ¡æœªè¿æ¥</h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                    ä¸‰è§’æ´²è¡ŒåŠ¨æ’ä»¶éœ€è¦ Puppeteer æ’ä»¶æ¥æ¸²æŸ“å›¾ç‰‡å¡ç‰‡ã€‚è¯·å…ˆå®‰è£…å¹¶å¯ç”¨ <code
                      class="px-2 py-0.5 bg-red-100 dark:bg-red-900/30 rounded text-red-600">napcat-plugin-puppeteer</code>
                    æ’ä»¶ã€‚
                  </p>
                  <div class="text-sm text-gray-500 dark:text-gray-400 space-y-1 mb-4">
                    <p class="font-medium text-gray-700 dark:text-gray-300">å®‰è£…æ–¹æ³•ï¼š</p>
                    <p>1. åœ¨ NapCat æ’ä»¶å•†åº—æœç´¢å¹¶å®‰è£… æ’ä»¶è‡ªåŠ¨æ›´æ–° <code
                        class="px-1 bg-gray-100 dark:bg-gray-700 rounded">napcat-plugin-autoupdate</code></p>
                    <p>2. è¿›å…¥ æ’ä»¶è‡ªåŠ¨æ›´æ–° <code
                        class="px-1 bg-gray-100 dark:bg-gray-700 rounded">napcat-plugin-autoupdate</code>
                      çš„ä»ªè¡¨ç›˜é¡µé¢</p>
                    <p>3. åœ¨ä»ªè¡¨ç›˜ä¸­ç‚¹å‡»å®‰è£… Puppeteer æ¸²æŸ“æœåŠ¡æ’ä»¶</p>
                    <p>4. å»ºè®®å°†æµè§ˆå™¨å®‰è£…åˆ° NapCat å®¹å™¨å†…</p>
                    <p>5. å®‰è£…å®Œæˆåç‚¹å‡»ä¸‹æ–¹"åˆ·æ–°çŠ¶æ€"æŒ‰é’®æ£€æŸ¥è¿æ¥</p>
                  </div>
                  <a href="https://github.com/AQiaoYo/napcat-plugin-puppeteer" target="_blank"
                    class="text-primary hover:underline text-sm">
                    ğŸ“– æŸ¥çœ‹ Puppeteer æ’ä»¶è¯¦ç»†æ–‡æ¡£
                  </a>
                </div>
              </div>
            </div>

            <div class="glass-card p-6 mb-6">
              <h3 class="font-bold text-lg mb-4">å¿«é€Ÿæ“ä½œ</h3>
              <div class="flex flex-wrap gap-3">
                <button onclick="refreshStatus()" class="btn btn-primary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                  åˆ·æ–°çŠ¶æ€
                </button>
                <button onclick="loadConfig()" class="btn btn-secondary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                  é‡è½½é…ç½®
                </button>
              </div>
            </div>

            <div class="glass-card p-6 mb-6">
              <h3 class="font-bold text-lg mb-4">è¿è¡Œè®¾ç½®</h3>
              <div class="space-y-4">
                <div class="config-row">
                  <div>
                    <div class="font-medium">WebSocket è‡ªåŠ¨è¿æ¥</div>
                    <div class="text-sm text-gray-500">å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ WebSocketï¼ˆç”¨äºæˆ˜ç»©æ¨é€ï¼‰</div>
                  </div>
                  <div class="toggle" id="wsAutoConnect" onclick="toggleSwitch(this)"></div>
                </div>
              </div>
            </div>

            <div class="glass-card p-6">
              <h3 class="font-bold text-lg mb-4">å…³äº</h3>
              <div class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                <p>â€¢ ç‰ˆæœ¬: <span class="text-primary font-medium" id="aboutVersion">-</span></p>
                <p>â€¢ å‘é€ <code class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded">ä¸‰è§’æ´²å¸®åŠ©</code> æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤</p>
                <p>â€¢ å‘é€ <code class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded">ä¸‰è§’æ´²ç™»å½•</code> æ‰«ç ç»‘å®šè´¦å·</p>
                <p>â€¢ ä½œè€…: <span class="font-medium">å†·æ›¦</span></p>
                <p>â€¢ GitHub: <a href="https://github.com/lengxi-root/napcat-plugin-lengxi" target="_blank"
                    class="text-primary hover:underline">napcat-plugin-lengxi</a></p>
                <p>â€¢ æ’ä»¶åé¦ˆç¾¤: <span class="text-primary font-medium">1085402468</span></p>
                <p>â€¢ APIäº¤æµç¾¤: <span class="text-primary font-medium">932459332</span></p>
              </div>
            </div>
          </div>

          <!-- Page: API -->
          <div id="page-api" class="page-content">
            <div class="glass-card p-6 mb-6">
              <div class="space-y-5">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API å¯†é’¥</label>
                  <input type="password" id="apiKey" class="input-field" placeholder="sk-xxxxxxx">
                  <p class="text-xs text-gray-500 mt-1">åœ¨ <a href="https://df.shallow.ink/api-keys" target="_blank"
                      class="text-primary hover:underline">df.shallow.ink/api-keys</a> è·å–</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å®¢æˆ·ç«¯ ID</label>
                  <input type="text" id="clientID" class="input-field" placeholder="ç”¨æˆ·ID">
                  <p class="text-xs text-gray-500 mt-1">åœ¨ <a href="https://df.shallow.ink/profile" target="_blank"
                      class="text-primary hover:underline">df.shallow.ink/profile</a> è·å–</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API æ¨¡å¼</label>
                  <select id="apiMode" class="input-field">
                    <option value="auto">è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆæ¨èï¼‰</option>
                    <option value="default">é»˜è®¤åœ°å€</option>
                    <option value="eo">EOç‰ˆåœ°å€</option>
                    <option value="esa">ESAç‰ˆåœ°å€</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="glass-card p-6">
              <div class="space-y-5">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æŒ‡ä»¤å‰ç¼€</label>
                  <input type="text" id="commandPrefix" class="input-field" placeholder="ä¸‰è§’æ´²,^">
                  <p class="text-xs text-gray-500 mt-1">å¤šä¸ªå‰ç¼€ç”¨è‹±æ–‡é€—å·åˆ†éš”</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Puppeteer æ’ä»¶ ID</label>
                  <input type="text" id="puppeteerId" class="input-field" placeholder="napcat-plugin-puppeteer">
                </div>
              </div>
            </div>
          </div>

          <!-- Page: Push -->
          <div id="page-push" class="page-content">
            <!-- Cron è¡¨è¾¾å¼è¯´æ˜ -->
            <div class="glass-card p-4 mb-6"
              style="background: rgba(249,115,22,0.05); border-color: rgba(249,115,22,0.2);">
              <h4 class="font-medium text-sm text-primary mb-2">Cron è¡¨è¾¾å¼æ ¼å¼è¯´æ˜</h4>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">æ ¼å¼: <code
                  class="px-1 bg-gray-100 dark:bg-gray-700 rounded">åˆ†é’Ÿ å°æ—¶ æ—¥ æœˆ æ˜ŸæœŸ</code></p>
              <div class="text-xs text-gray-500 space-y-1">
                <p>â€¢ <code class="px-1 bg-gray-100 dark:bg-gray-700 rounded">0 8 * * *</code> - æ¯å¤© 08:00</p>
                <p>â€¢ <code class="px-1 bg-gray-100 dark:bg-gray-700 rounded">0 10 * * *</code> - æ¯å¤© 10:00</p>
                <p>â€¢ <code class="px-1 bg-gray-100 dark:bg-gray-700 rounded">0 10 * * 1</code> - æ¯å‘¨ä¸€ 10:00</p>
                <p>â€¢ <code class="px-1 bg-gray-100 dark:bg-gray-700 rounded">0 8,20 * * *</code> - æ¯å¤© 08:00 å’Œ 20:00</p>
                <p>â€¢ <code class="px-1 bg-gray-100 dark:bg-gray-700 rounded">*/30 * * * *</code> - æ¯ 30 åˆ†é’Ÿ</p>
              </div>
            </div>

            <div class="glass-card p-6">
              <!-- æ¯æ—¥å¯†ç æ¨é€ -->
              <div class="config-section">
                <div class="section-title">æ¯æ—¥å¯†ç æ¨é€</div>
                <div class="config-row">
                  <div>
                    <div class="font-medium">å¯ç”¨æ¯æ—¥å¯†ç æ¨é€</div>
                    <div class="text-sm text-gray-500">æ¯å¤©å®šæ—¶æ¨é€å¯†ç åˆ°æŒ‡å®šç¾¤</div>
                  </div>
                  <div class="toggle" id="pushDailyKeyword" onclick="toggleSwitch(this)"></div>
                </div>
                <div class="config-row-expand">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€æ—¶é—´ (Cron)</label>
                      <input type="text" id="pushDailyKeywordCron" class="input-field" placeholder="0 8 * * *">
                    </div>
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€ç¾¤å·</label>
                      <div class="flex gap-2 mb-2">
                        <select id="pushKeywordGroupSel" class="input-field group-selector flex-1"></select>
                        <button type="button" onclick="addGroupToInput('pushKeywordGroupSel', 'pushDailyKeywordGroups')"
                          class="btn btn-primary text-sm">æ·»åŠ </button>
                      </div>
                      <input type="text" id="pushDailyKeywordGroups" class="input-field" placeholder="å·²é€‰ç¾¤å·ï¼Œé€—å·åˆ†éš”">
                    </div>
                  </div>
                </div>
              </div>

              <!-- æ¯æ—¥æˆ˜æŠ¥æ¨é€ -->
              <div class="config-section">
                <div class="section-title">æ¯æ—¥æˆ˜æŠ¥æ¨é€</div>
                <div class="config-row">
                  <div>
                    <div class="font-medium">å¯ç”¨æ¯æ—¥æˆ˜æŠ¥æ¨é€</div>
                    <div class="text-sm text-gray-500">æ¯å¤©æ¨é€æˆ˜æŠ¥æ•°æ®</div>
                  </div>
                  <div class="toggle" id="pushDailyReport" onclick="toggleSwitch(this)"></div>
                </div>
                <div class="config-row-expand">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€æ—¶é—´ (Cron)</label>
                      <input type="text" id="pushDailyReportCron" class="input-field" placeholder="0 10 * * *">
                    </div>
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€ç¾¤å·</label>
                      <div class="flex gap-2 mb-2">
                        <select id="pushDailyReportGroupSel" class="input-field group-selector flex-1"></select>
                        <button type="button"
                          onclick="addGroupToInput('pushDailyReportGroupSel', 'pushDailyReportGroups')"
                          class="btn btn-primary text-sm">æ·»åŠ </button>
                      </div>
                      <input type="text" id="pushDailyReportGroups" class="input-field" placeholder="å·²é€‰ç¾¤å·ï¼Œé€—å·åˆ†éš”">
                    </div>
                  </div>
                </div>
              </div>

              <!-- æ¯å‘¨æˆ˜æŠ¥æ¨é€ -->
              <div class="config-section">
                <div class="section-title">æ¯å‘¨æˆ˜æŠ¥æ¨é€</div>
                <div class="config-row">
                  <div>
                    <div class="font-medium">å¯ç”¨æ¯å‘¨æˆ˜æŠ¥æ¨é€</div>
                    <div class="text-sm text-gray-500">æ¯å‘¨æ¨é€æˆ˜æŠ¥æ•°æ®</div>
                  </div>
                  <div class="toggle" id="pushWeeklyReport" onclick="toggleSwitch(this)"></div>
                </div>
                <div class="config-row-expand">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€æ—¶é—´ (Cron)</label>
                      <input type="text" id="pushWeeklyReportCron" class="input-field" placeholder="0 10 * * 1">
                    </div>
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€ç¾¤å·</label>
                      <div class="flex gap-2 mb-2">
                        <select id="pushWeeklyReportGroupSel" class="input-field group-selector flex-1"></select>
                        <button type="button"
                          onclick="addGroupToInput('pushWeeklyReportGroupSel', 'pushWeeklyReportGroups')"
                          class="btn btn-primary text-sm">æ·»åŠ </button>
                      </div>
                      <input type="text" id="pushWeeklyReportGroups" class="input-field" placeholder="å·²é€‰ç¾¤å·ï¼Œé€—å·åˆ†éš”">
                    </div>
                  </div>
                </div>
              </div>

              <!-- ç‰¹å‹¤å¤„çŠ¶æ€æ¨é€ -->
              <div class="config-section">
                <div class="section-title">ç‰¹å‹¤å¤„çŠ¶æ€æ¨é€</div>
                <div class="config-row">
                  <div>
                    <div class="font-medium">å¯ç”¨ç‰¹å‹¤å¤„çŠ¶æ€æ¨é€</div>
                    <div class="text-sm text-gray-500">å®šæ—¶æ£€æŸ¥ç‰¹å‹¤å¤„ç”Ÿäº§çŠ¶æ€</div>
                  </div>
                  <div class="toggle" id="pushPlaceStatus" onclick="toggleSwitch(this)"></div>
                </div>
                <div class="config-row-expand">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ£€æŸ¥é¢‘ç‡ (Cron)</label>
                      <input type="text" id="pushPlaceStatusCron" class="input-field" placeholder="*/5 * * * *">
                    </div>
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€ç¾¤å·</label>
                      <div class="flex gap-2 mb-2">
                        <select id="pushPlaceStatusGroupSel" class="input-field group-selector flex-1"></select>
                        <button type="button"
                          onclick="addGroupToInput('pushPlaceStatusGroupSel', 'pushPlaceStatusGroups')"
                          class="btn btn-primary text-sm">æ·»åŠ </button>
                      </div>
                      <input type="text" id="pushPlaceStatusGroups" class="input-field" placeholder="å·²é€‰ç¾¤å·ï¼Œé€—å·åˆ†éš”">
                    </div>
                  </div>
                </div>
              </div>

              <!-- å¹¿æ’­é€šçŸ¥ -->
              <div class="config-section">
                <div class="section-title">å¹¿æ’­é€šçŸ¥</div>
                <div class="config-row">
                  <div>
                    <div class="font-medium">å¯ç”¨å¹¿æ’­é€šçŸ¥</div>
                    <div class="text-sm text-gray-500">æ¥æ”¶æœåŠ¡å™¨æ¨é€çš„ç³»ç»Ÿå¹¿æ’­</div>
                  </div>
                  <div class="toggle" id="broadcastEnabled" onclick="toggleSwitch(this)"></div>
                </div>
                <div class="config-row-expand">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€ç¾¤å·</label>
                      <div class="flex gap-2 mb-2">
                        <select id="broadcastGroupSel" class="input-field group-selector flex-1"></select>
                        <button type="button" onclick="addGroupToInput('broadcastGroupSel', 'broadcastGroups')"
                          class="btn btn-primary text-sm">æ·»åŠ </button>
                      </div>
                      <input type="text" id="broadcastGroups" class="input-field" placeholder="å·²é€‰ç¾¤å·ï¼Œé€—å·åˆ†éš”">
                    </div>
                    <div>
                      <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¨é€å¥½å‹</label>
                      <div class="flex gap-2 mb-2">
                        <select id="broadcastFriendSel" class="input-field friend-selector flex-1"></select>
                        <button type="button" onclick="addFriendToInput('broadcastFriendSel', 'broadcastPrivates')"
                          class="btn btn-primary text-sm">æ·»åŠ </button>
                      </div>
                      <input type="text" id="broadcastPrivates" class="input-field" placeholder="å·²é€‰å¥½å‹QQï¼Œé€—å·åˆ†éš”">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Page: TTS -->
          <div id="page-tts" class="page-content">
            <div class="glass-card p-6 mb-6">
              <div class="config-section">
                <div class="config-row">
                  <div>
                    <div class="font-medium">å¯ç”¨ TTS</div>
                    <div class="text-sm text-gray-500">ä½¿ç”¨ ^tts å‘½ä»¤è¿›è¡Œè¯­éŸ³åˆæˆ</div>
                  </div>
                  <div class="toggle active" id="ttsEnabled" onclick="toggleSwitch(this)"></div>
                </div>
              </div>

              <div class="config-section">
                <div class="section-title">åŸºç¡€è®¾ç½®</div>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æœ€å¤§å­—æ•°é™åˆ¶</label>
                    <input type="number" id="ttsMaxLength" class="input-field" value="800" min="20" max="800">
                    <p class="text-xs text-gray-500 mt-1">èŒƒå›´ 20-800ï¼Œé»˜è®¤ 800</p>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">é»‘ç™½åå•æ¨¡å¼</label>
                    <select id="ttsMode" class="input-field">
                      <option value="blacklist">é»‘åå•æ¨¡å¼</option>
                      <option value="whitelist">ç™½åå•æ¨¡å¼</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">ç¾¤å·åˆ—è¡¨</label>
                    <div class="flex gap-2 mb-2">
                      <select id="ttsGroupSel" class="input-field group-selector flex-1"></select>
                      <button type="button" onclick="addGroupToInput('ttsGroupSel', 'ttsGroupList')"
                        class="btn btn-primary text-sm">æ·»åŠ </button>
                    </div>
                    <input type="text" id="ttsGroupList" class="input-field" placeholder="å·²é€‰ç¾¤å·ï¼Œé€—å·åˆ†éš”">
                  </div>
                  <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">ç”¨æˆ·QQåˆ—è¡¨</label>
                    <div class="flex gap-2 mb-2">
                      <select id="ttsUserSel" class="input-field friend-selector flex-1"></select>
                      <button type="button" onclick="addFriendToInput('ttsUserSel', 'ttsUserList')"
                        class="btn btn-primary text-sm">æ·»åŠ </button>
                    </div>
                    <input type="text" id="ttsUserList" class="input-field" placeholder="å·²é€‰ç”¨æˆ·QQï¼Œé€—å·åˆ†éš”">
                  </div>
                </div>
              </div>
            </div>

            <div class="glass-card p-6">
              <div class="config-section">
                <div class="config-row">
                  <div>
                    <div class="font-medium">å¯ç”¨ AI è¯„ä»· TTS</div>
                    <div class="text-sm text-gray-500">AI è¯„ä»·å‘½ä»¤å¯é™„åŠ éŸ³è‰²å‚æ•°ç”Ÿæˆè¯­éŸ³</div>
                  </div>
                  <div class="toggle active" id="ttsAiEnabled" onclick="toggleSwitch(this)"></div>
                </div>
              </div>

              <div class="config-section">
                <div class="section-title">æƒé™è®¾ç½®</div>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">é»‘ç™½åå•æ¨¡å¼</label>
                    <select id="ttsAiMode" class="input-field">
                      <option value="blacklist">é»‘åå•æ¨¡å¼</option>
                      <option value="whitelist">ç™½åå•æ¨¡å¼</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">ç¾¤å·åˆ—è¡¨</label>
                    <div class="flex gap-2 mb-2">
                      <select id="ttsAiGroupSel" class="input-field group-selector flex-1"></select>
                      <button type="button" onclick="addGroupToInput('ttsAiGroupSel', 'ttsAiGroupList')"
                        class="btn btn-primary text-sm">æ·»åŠ </button>
                    </div>
                    <input type="text" id="ttsAiGroupList" class="input-field" placeholder="å·²é€‰ç¾¤å·ï¼Œé€—å·åˆ†éš”">
                  </div>
                  <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">ç”¨æˆ·QQåˆ—è¡¨</label>
                    <div class="flex gap-2 mb-2">
                      <select id="ttsAiUserSel" class="input-field friend-selector flex-1"></select>
                      <button type="button" onclick="addFriendToInput('ttsAiUserSel', 'ttsAiUserList')"
                        class="btn btn-primary text-sm">æ·»åŠ </button>
                    </div>
                    <input type="text" id="ttsAiUserList" class="input-field" placeholder="å·²é€‰ç”¨æˆ·QQï¼Œé€—å·åˆ†éš”">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Page: Help -->
          <div id="page-help" class="page-content">
            <!-- å¸®åŠ©é¢„è§ˆæ ·å¼ï¼ˆç´§å‡‘ç‰ˆï¼‰ -->
            <style>
              .help-preview-wrap {
                background-size: cover;
                background-position: center;
                border-radius: 8px;
                padding: 12px;
                min-height: 200px;
                transform: scale(0.85);
                transform-origin: top left;
                width: 117.6%;
              }

              .help-preview-head {
                border-radius: 10px;
                padding: 8px 15px;
                margin-bottom: 8px;
                cursor: pointer;
                transition: all 0.2s;
              }

              .help-preview-head:hover {
                opacity: 0.9;
              }

              .help-preview-title {
                font-size: 28px;
                font-weight: bold;
                text-shadow: 0 0 1px #000, 1px 1px 2px rgba(0, 0, 0, 0.9);
              }

              .help-preview-subtitle {
                font-size: 13px;
                text-shadow: 0 0 1px #000, 1px 1px 2px rgba(0, 0, 0, 0.9);
              }

              .help-preview-group {
                border-radius: 10px;
                margin-bottom: 8px;
                overflow: hidden;
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
              }

              .help-preview-group-title {
                font-size: 15px;
                font-weight: bold;
                padding: 8px 12px;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }

              .help-preview-group-title:hover {
                opacity: 0.85;
              }

              .help-preview-table {
                display: table;
                width: 100%;
                table-layout: fixed;
              }

              .help-preview-row {
                display: table-row;
              }

              .help-preview-cell {
                display: table-cell;
                padding: 8px 10px 8px 42px;
                position: relative;
                cursor: pointer;
                transition: all 0.15s;
                border: 1px solid transparent;
              }

              .help-preview-cell:hover {
                opacity: 0.8;
                border-color: rgba(206, 183, 139, 0.5);
              }

              .help-preview-cell.active {
                border-color: #ceb78b;
                box-shadow: 0 0 6px rgba(206, 183, 139, 0.4);
              }

              .help-preview-icon {
                width: 30px;
                height: 30px;
                position: absolute;
                left: 6px;
                top: 8px;
                border-radius: 3px;
                background-size: 300px auto;
              }

              .help-preview-cell-title {
                font-size: 14px;
                font-weight: 600;
                line-height: 18px;
              }

              .help-preview-cell-desc {
                font-size: 12px;
                line-height: 16px;
                opacity: 0.9;
              }

              .help-preview-add-cell {
                display: table-cell;
                padding: 8px;
                text-align: center;
                cursor: pointer;
                border: 1px dashed rgba(206, 183, 139, 0.3);
                border-radius: 5px;
                color: rgba(206, 183, 139, 0.6);
                font-size: 11px;
                transition: all 0.2s;
              }

              .help-preview-add-cell:hover {
                border-color: rgba(206, 183, 139, 0.6);
                color: #ceb78b;
              }

              .help-preview-columns {
                display: flex;
                gap: 8px;
              }

              .help-preview-column {
                flex: 1;
              }

              .help-preview-add-group {
                padding: 10px;
                text-align: center;
                border: 1px dashed rgba(206, 183, 139, 0.3);
                border-radius: 10px;
                color: rgba(206, 183, 139, 0.6);
                cursor: pointer;
                margin-top: 6px;
                font-size: 11px;
                transition: all 0.2s;
              }

              .help-preview-add-group:hover {
                border-color: rgba(206, 183, 139, 0.6);
                color: #ceb78b;
              }

              /* å›¾æ ‡é€‰æ‹©å™¨æ ·å¼ */
              .icon-picker-grid {
                display: grid;
                grid-template-columns: repeat(10, 1fr);
                gap: 4px;
                max-height: 200px;
                overflow-y: auto;
                padding: 8px;
                background: #f3f4f6;
                border-radius: 8px;
              }

              .dark .icon-picker-grid {
                background: #374151;
              }

              .icon-picker-item {
                width: 32px;
                height: 32px;
                cursor: pointer;
                border: 2px solid transparent;
                border-radius: 4px;
                background-size: 320px auto;
                transition: all 0.15s;
                position: relative;
              }

              .icon-delete-btn {
                position: absolute;
                top: -6px;
                right: -6px;
                width: 14px;
                height: 14px;
                background: #ef4444;
                color: #fff;
                border-radius: 50%;
                font-size: 10px;
                line-height: 14px;
                text-align: center;
                display: none;
                cursor: pointer;
              }

              .icon-picker-item:hover .icon-delete-btn {
                display: block;
              }

              .icon-picker-item:hover {
                border-color: #3b82f6;
                transform: scale(1.1);
              }

              .icon-picker-item.selected {
                border-color: #3b82f6;
                box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
              }
            </style>

            <!-- å¸®åŠ©é¢„è§ˆåŒºåŸŸï¼ˆç±»ä¼¼çœŸå®æ¸²æŸ“æ•ˆæœï¼‰ -->
            <div id="helpPreviewWrap" class="help-preview-wrap mb-6"
              style="background-image: url(''); background-color: #1a2634;">
              <!-- å¤´éƒ¨æ ‡é¢˜åŒºåŸŸ -->
              <div id="helpPreviewHead" class="help-preview-head" onclick="openTitleEditModal()"
                style="background: transparent;">
                <div id="helpPreviewTitle" class="help-preview-title" style="color: #ceb78b;">ä¸‰è§’æ´²è¡ŒåŠ¨ å¸®åŠ©</div>
                <div id="helpPreviewSubtitle" class="help-preview-subtitle" style="color: #ceb78b;">DeltaForce-Plugin
                  HELP</div>
              </div>

              <!-- å…¨å®½åˆ†ç»„åŒºåŸŸ -->
              <div id="helpFullWidthContainer"></div>

              <!-- ä¸¤åˆ—å¸ƒå±€ -->
              <div class="help-preview-columns">
                <div id="helpLeftColumn" class="help-preview-column"></div>
                <div id="helpRightColumn" class="help-preview-column"></div>
              </div>

              <!-- åº•æ æ–‡æœ¬ -->
              <div id="helpPreviewFooter" class="help-preview-footer"
                style="text-align: center; padding: 8px 12px; font-size: 12px; color: rgba(206,183,139,0.6); cursor: pointer;"
                onclick="openFooterEditModal()">
              </div>
            </div>

            <!-- éšè—è¾“å…¥ -->
            <input type="hidden" id="helpTitle">
            <input type="hidden" id="helpSubTitle">
            <input type="hidden" id="helpFooterText">

            <!-- æ ·å¼é…ç½®å¼¹çª— -->
            <div id="styleConfigModal"
              class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
              <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden max-h-[85vh] flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                  <h3 class="font-bold text-lg">ğŸ¨ æ ·å¼é…ç½®</h3>
                  <button onclick="closeStyleConfigModal()"
                    class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                  <!-- é¢œè‰²é…ç½® -->
                  <div class="config-section mb-4">
                    <div class="section-title text-sm">é¢œè‰²é…ç½®</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">ä¸»æ–‡å­—é¢œè‰²</label>
                        <div class="flex gap-2">
                          <input type="color" id="helpFontColorPicker" class="w-10 h-10 rounded cursor-pointer"
                            value="#ceb78b">
                          <input type="text" id="helpFontColor" class="input-field flex-1" placeholder="#ceb78b">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æè¿°æ–‡å­—é¢œè‰²</label>
                        <div class="flex gap-2">
                          <input type="color" id="helpDescColorPicker" class="w-10 h-10 rounded cursor-pointer"
                            value="#eeeeee">
                          <input type="text" id="helpDescColor" class="input-field flex-1" placeholder="#eee">
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- èƒŒæ™¯é…ç½® -->
                  <div class="config-section mb-4">
                    <div class="section-title text-sm">èƒŒæ™¯é…ç½®</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">é¢æ¿åº•è‰²</label>
                        <div class="flex gap-2 items-center">
                          <input type="color" id="helpContBgColorPicker"
                            class="w-8 h-8 rounded cursor-pointer flex-shrink-0" value="#2b343d">
                          <input type="text" id="helpContBgColor" class="input-field flex-1 text-xs"
                            placeholder="rgba(43, 52, 61, 0.8)">
                          <input type="range" id="helpContBgAlpha" class="w-16 flex-shrink-0" min="0" max="1"
                            step="0.05" value="0.8">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ¯›ç»ç’ƒæ¨¡ç³Šåº¦</label>
                        <div class="flex items-center gap-2">
                          <input type="range" id="helpContBgBlur" class="flex-1" min="0" max="10" step="0.5" value="3">
                          <span id="helpContBgBlurValue" class="text-sm w-8">3</span>
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ ‡é¢˜æ åº•è‰²</label>
                        <div class="flex gap-2 items-center">
                          <input type="color" id="helpHeaderBgColorPicker"
                            class="w-8 h-8 rounded cursor-pointer flex-shrink-0" value="#222933">
                          <input type="text" id="helpHeaderBgColor" class="input-field flex-1 text-xs"
                            placeholder="rgba(34, 41, 51, .4)">
                          <input type="range" id="helpHeaderBgAlpha" class="w-16 flex-shrink-0" min="0" max="1"
                            step="0.05" value="0.4">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">å¥‡æ•°è¡Œåº•è‰²</label>
                        <div class="flex gap-2 items-center">
                          <input type="color" id="helpRowBgColor1Picker"
                            class="w-8 h-8 rounded cursor-pointer flex-shrink-0" value="#222933">
                          <input type="text" id="helpRowBgColor1" class="input-field flex-1 text-xs"
                            placeholder="rgba(34, 41, 51, .2)">
                          <input type="range" id="helpRowBgColor1Alpha" class="w-16 flex-shrink-0" min="0" max="1"
                            step="0.05" value="0.2">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">å¶æ•°è¡Œåº•è‰²</label>
                        <div class="flex gap-2 items-center">
                          <input type="color" id="helpRowBgColor2Picker"
                            class="w-8 h-8 rounded cursor-pointer flex-shrink-0" value="#222933">
                          <input type="text" id="helpRowBgColor2" class="input-field flex-1 text-xs"
                            placeholder="rgba(34, 41, 51, .4)">
                          <input type="range" id="helpRowBgColor2Alpha" class="w-16 flex-shrink-0" min="0" max="1"
                            step="0.05" value="0.4">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">æ–¹å—èƒŒæ™¯è‰²</label>
                        <div class="flex gap-2 items-center">
                          <input type="color" id="helpCellBgColorPicker"
                            class="w-8 h-8 rounded cursor-pointer flex-shrink-0" value="#222933">
                          <input type="text" id="helpCellBgColor" class="input-field flex-1 text-xs"
                            placeholder="rgba(34, 41, 51, .35)">
                          <input type="range" id="helpCellBgAlpha" class="w-16 flex-shrink-0" min="0" max="1"
                            step="0.05" value="0.35">
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- å›¾ç‰‡ä¸Šä¼  -->
                  <div class="config-section mb-4">
                    <div class="section-title text-sm">è‡ªå®šä¹‰å›¾ç‰‡</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm text-gray-600 dark:text-gray-400 mb-2">èƒŒæ™¯å›¾ç‰‡</label>
                        <div class="flex items-center gap-2">
                          <div id="bgPreview"
                            class="w-20 h-12 rounded border border-gray-300 dark:border-gray-600 bg-cover bg-center bg-gray-200 dark:bg-gray-700">
                          </div>
                          <div class="flex-1">
                            <input type="file" id="bgUpload" accept="image/jpeg,image/png,image/webp" class="hidden"
                              onchange="uploadHelpImage('bg')">
                            <button onclick="document.getElementById('bgUpload').click()"
                              class="btn text-xs px-3 py-1.5 w-full">é€‰æ‹©å›¾ç‰‡</button>
                          </div>
                          <button onclick="resetHelpImage('bg')"
                            class="btn text-xs px-2 py-1.5 text-gray-500">é‡ç½®</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">å»ºè®®å°ºå¯¸: 1920x1080ï¼Œæ”¯æŒ jpg/png/webp</p>
                      </div>
                      <div></div>
                    </div>
                  </div>
                  <!-- å­—ä½“é…ç½® -->
                  <div class="config-section">
                    <div class="section-title text-sm">å­—ä½“é…ç½®</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">ä¸»æ ‡é¢˜</label>
                        <input type="text" id="helpTitleFontSize" class="input-field text-sm" placeholder="50px">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">ç»„æ ‡é¢˜</label>
                        <input type="text" id="helpGroupFontSize" class="input-field text-sm" placeholder="18px">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">å‘½ä»¤æ ‡é¢˜</label>
                        <input type="text" id="helpCommandFontSize" class="input-field text-sm" placeholder="16px">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">æè¿°æ–‡å­—</label>
                        <input type="text" id="helpDescFontSize" class="input-field text-sm" placeholder="13px">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç¼–è¾‘å¸®åŠ©é¡¹å¼¹çª— -->
        <div id="helpEditModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
              <h3 class="font-bold text-lg" id="helpEditModalTitle">ç¼–è¾‘å¸®åŠ©é¡¹</h3>
              <button onclick="closeHelpEditModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
            <div class="p-6 space-y-4">
              <div id="iconPickerSection">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">é€‰æ‹©å›¾æ ‡</label>
                <input type="hidden" id="editHelpIcon" value="80">
                <div id="iconPickerGrid" class="icon-picker-grid"></div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å‘½ä»¤æ ‡é¢˜</label>
                <input type="text" id="editHelpTitle" class="input-field" placeholder="^å¸®åŠ©">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æè¿°è¯´æ˜</label>
                <input type="text" id="editHelpDesc" class="input-field" placeholder="æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯">
              </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
              <button onclick="deleteHelpItem()"
                class="btn px-4 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">åˆ é™¤</button>
              <button onclick="closeHelpEditModal()" class="btn px-4 py-2">å–æ¶ˆ</button>
              <button onclick="saveHelpItem()" class="btn btn-primary px-4 py-2">ä¿å­˜</button>
            </div>
          </div>
        </div>

        <!-- ç¼–è¾‘åˆ†ç»„å¼¹çª— -->
        <div id="groupEditModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
              <h3 class="font-bold text-lg">ç¼–è¾‘åˆ†ç»„</h3>
              <button onclick="closeGroupEditModal()"
                class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">åˆ†ç»„åç§°</label>
                <input type="text" id="editGroupName" class="input-field" placeholder="è´¦å·ç›¸å…³">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ’åºï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰</label>
                <input type="number" id="editGroupOrder" class="input-field" min="1" max="99" placeholder="1">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ä½ç½®</label>
                <select id="editGroupPosition" class="input-field">
                  <option value="left">å·¦åˆ—</option>
                  <option value="right">å³åˆ—</option>
                  <option value="fullWidth">å…¨å®½</option>
                </select>
              </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
              <button onclick="deleteHelpGroup()"
                class="btn px-4 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">åˆ é™¤åˆ†ç»„</button>
              <button onclick="closeGroupEditModal()" class="btn px-4 py-2">å–æ¶ˆ</button>
              <button onclick="saveHelpGroup()" class="btn btn-primary px-4 py-2">ä¿å­˜</button>
            </div>
          </div>
        </div>

        <!-- ç¡®è®¤å¼¹çª— -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
              <h3 class="font-bold text-lg" id="confirmModalTitle">ç¡®è®¤æ“ä½œ</h3>
            </div>
            <div class="p-6">
              <p class="text-gray-600 dark:text-gray-400" id="confirmModalMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
              <button onclick="closeConfirmModal(false)" class="btn px-4 py-2">å–æ¶ˆ</button>
              <button onclick="closeConfirmModal(true)"
                class="btn btn-primary px-4 py-2 bg-red-500 hover:bg-red-600">ç¡®å®š</button>
            </div>
          </div>
        </div>

        <!-- Page: Settings -->
        <!-- page-settings å·²åˆå¹¶åˆ° page-status -->
        <div id="page-settings" class="page-content"></div>

        <!-- è°ƒè¯•æ—¥å¿—é¡µé¢ -->
        <div id="page-debug" class="page-content">
          <div class="glass-card p-6 mb-4">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="font-bold text-lg">ğŸ” è°ƒè¯•æ—¥å¿—</h3>
                <p class="text-sm text-gray-500 mt-1">å¼€å¯åæ‰€æœ‰æ—¥å¿—å’ŒAPIè¯·æ±‚è¯¦æƒ…å°†å®æ—¶æ˜¾ç¤ºåœ¨æ­¤é¢æ¿ï¼Œä¸å†è¾“å‡ºåˆ°æ¡†æ¶æ—¥å¿—</p>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-sm" id="debugStatusText">å·²å…³é—­</span>
                <div class="toggle" id="webDebugToggle" onclick="toggleWebDebug(this)"></div>
              </div>
            </div>
            <div class="flex gap-2 flex-wrap">
              <button onclick="clearDebugLogs()"
                class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">æ¸…ç©ºæ—¥å¿—</button>
              <button onclick="toggleAutoScroll()" id="btnAutoScroll"
                class="px-3 py-1.5 text-sm bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition">â¬‡ è‡ªåŠ¨æ»šåŠ¨:
                å¼€</button>
              <select id="debugFilter" onchange="applyDebugFilter()"
                class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg border-0 outline-none">
                <option value="all">å…¨éƒ¨æ—¥å¿—</option>
                <option value="api">ä»…APIè¯·æ±‚</option>
                <option value="error">ä»…é”™è¯¯</option>
                <option value="warn">è­¦å‘Š+é”™è¯¯</option>
                <option value="debug">ä»…è°ƒè¯•</option>
              </select>
              <span class="text-xs text-gray-400 self-center ml-auto" id="debugLogCount">0 æ¡</span>
            </div>
          </div>
          <div class="glass-card" style="height:calc(100vh - 280px);display:flex;flex-direction:column;">
            <div id="debugLogContainer"
              class="flex-1 overflow-y-auto custom-scrollbar p-4 font-mono text-xs leading-relaxed"
              style="background:rgba(0,0,0,0.03);">
              <div class="text-center text-gray-400 py-12" id="debugEmpty">å¼€å¯è°ƒè¯•æ¨¡å¼åï¼Œæ—¥å¿—å°†åœ¨æ­¤å®æ—¶æ˜¾ç¤º</div>
            </div>
          </div>
        </div>
    </div>
    </main>
  </div>
  </div>

  <script>
    const PLUGIN_NAME = 'napcat-plugin-delta-force';
    const API_BASE = `/api/Plugin/ext/${PLUGIN_NAME}`;
    const API_NO_AUTH = `/plugin/${PLUGIN_NAME}/api`;
    const STATIC_FILES = `/plugin/${PLUGIN_NAME}/files/static`;

    function switchPage (pageId, el) {
      document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      el.classList.add('active');
      // å¸®åŠ©é¡µä¸“å±æŒ‰é’®
      document.getElementById('btnResetHelp').style.display = pageId === 'help' ? '' : 'none';
      document.getElementById('btnStyleConfig').style.display = pageId === 'help' ? '' : 'none';
    }

    function toggleSwitch (el) { el.classList.toggle('active'); }

    function showToast (msg, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      const colors = { success: '#10b981', error: '#ef4444', info: '#F97316' };
      toast.innerHTML = `<div style="width:4px;height:24px;background:${colors[type]};border-radius:2px;"></div><span>${msg}</span>`;
      container.appendChild(toast);
      setTimeout(() => { toast.style.animation = 'slideIn 0.3s ease reverse'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // å®‰å…¨è®¾ç½®å…ƒç´ å±æ€§ï¼ˆå…ƒç´ ä¸å­˜åœ¨ä¸æŠ¥é”™ï¼‰
    function $set (id, prop, val) {
      const el = document.getElementById(id);
      if (el) el[prop] = val;
    }

    async function refreshStatus () {
      try {
        const res = await fetch(`${API_NO_AUTH}/status`);
        const data = await res.json();
        if (data.code === 0) {
          $set('statusDot', 'className', 'status-dot connected');
          $set('statusText', 'textContent', 'è¿è¡Œä¸­');
          const version = 'v' + (data.data?.version || '1.0.0');
          $set('statVersion', 'textContent', version);
          $set('aboutVersion', 'textContent', version);

          const puppeteerConnected = data.data?.puppeteer?.connected;
          $set('statPuppeteer', 'innerHTML', puppeteerConnected
            ? '<span class="text-green-500">å·²è¿æ¥</span>'
            : '<span class="text-red-500">æœªè¿æ¥</span>');

          const warningEl = document.getElementById('puppeteerWarning');
          if (warningEl) warningEl.style.display = puppeteerConnected ? 'none' : 'block';

          showToast('çŠ¶æ€åˆ·æ–°æˆåŠŸ', 'success');
        }
      } catch (e) {
        $set('statusDot', 'className', 'status-dot disconnected');
        $set('statusText', 'textContent', 'ç¦»çº¿');
        const warningEl = document.getElementById('puppeteerWarning');
        if (warningEl) warningEl.style.display = 'block';
        showToast('è¿æ¥å¤±è´¥: ' + e, 'error');
      }
    }

    async function loadConfig () {
      try {
        // ä¼˜å…ˆå°è¯•æ— è®¤è¯æ¥å£
        let res = await fetch(`${API_NO_AUTH}/config`);
        if (!res.ok) {
          // å¦‚æœæ— è®¤è¯æ¥å£å¤±è´¥ï¼Œå°è¯•éœ€è®¤è¯æ¥å£
          res = await fetch(`${API_BASE}/config`);
        }
        if (!res.ok) {
          showToast(`åŠ è½½é…ç½®å¤±è´¥: HTTP ${res.status}`, 'error');
          return;
        }
        const data = await res.json();
        console.log('åŠ è½½é…ç½®å“åº”:', data);
        if (data.code === 0 && data.data) {
          const cfg = data.data;
          console.log('é…ç½®æ•°æ®:', cfg);

          // API é…ç½®
          document.getElementById('apiKey').value = cfg.api_key || '';
          document.getElementById('clientID').value = cfg.clientID || '';
          document.getElementById('apiMode').value = cfg.api_mode || 'auto';
          document.getElementById('statMode').textContent = (cfg.api_mode || 'auto').toUpperCase();
          document.getElementById('commandPrefix').value = Array.isArray(cfg.command_prefix) ? cfg.command_prefix.join(',') : (cfg.command_prefix || 'ä¸‰è§’æ´²,^');
          document.getElementById('puppeteerId').value = cfg.puppeteer_plugin_id || 'napcat-plugin-puppeteer';

          // æ¨é€é…ç½®
          setToggle('pushDailyKeyword', cfg.push_daily_keyword?.enabled);
          document.getElementById('pushDailyKeywordCron').value = cfg.push_daily_keyword?.cron || '0 8 * * *';
          document.getElementById('pushDailyKeywordGroups').value = arrayToString(cfg.push_daily_keyword?.push_to?.group);

          setToggle('pushDailyReport', cfg.push_daily_report?.enabled);
          document.getElementById('pushDailyReportCron').value = cfg.push_daily_report?.cron || '0 10 * * *';
          document.getElementById('pushDailyReportGroups').value = arrayToString(cfg.push_daily_report?.push_to?.group);

          setToggle('pushWeeklyReport', cfg.push_weekly_report?.enabled);
          document.getElementById('pushWeeklyReportCron').value = cfg.push_weekly_report?.cron || '0 10 * * 1';
          document.getElementById('pushWeeklyReportGroups').value = arrayToString(cfg.push_weekly_report?.push_to?.group);

          setToggle('pushPlaceStatus', cfg.push_place_status?.enabled);
          document.getElementById('pushPlaceStatusCron').value = cfg.push_place_status?.cron || '*/5 * * * *';
          document.getElementById('pushPlaceStatusGroups').value = arrayToString(cfg.push_place_status?.push_to?.group);

          // å¹¿æ’­é…ç½®
          setToggle('broadcastEnabled', cfg.broadcast_notification?.enabled);
          document.getElementById('broadcastGroups').value = arrayToString(cfg.broadcast_notification?.push_to?.group);
          setToggle('broadcastPrivateEnabled', cfg.broadcast_notification?.push_to?.private_enabled);
          document.getElementById('broadcastPrivates').value = arrayToString(cfg.broadcast_notification?.push_to?.private);

          // TTS é…ç½®
          setToggle('ttsEnabled', cfg.tts?.enabled !== false);
          document.getElementById('ttsMaxLength').value = cfg.tts?.max_length || 800;
          document.getElementById('ttsMode').value = cfg.tts?.mode || 'blacklist';
          document.getElementById('ttsGroupList').value = arrayToString(cfg.tts?.group_list);
          document.getElementById('ttsUserList').value = arrayToString(cfg.tts?.user_list);

          // AI TTS é…ç½®
          setToggle('ttsAiEnabled', cfg.tts?.ai_tts?.enabled !== false);
          document.getElementById('ttsAiMode').value = cfg.tts?.ai_tts?.mode || 'blacklist';
          document.getElementById('ttsAiGroupList').value = arrayToString(cfg.tts?.ai_tts?.group_list);
          document.getElementById('ttsAiUserList').value = arrayToString(cfg.tts?.ai_tts?.user_list);

          // å¸®åŠ©é…ç½®
          const helpCfg = cfg.help_style || {};
          document.getElementById('helpTitle').value = helpCfg.title || 'ä¸‰è§’æ´²è¡ŒåŠ¨ å¸®åŠ©';
          document.getElementById('helpSubTitle').value = helpCfg.subTitle || 'DeltaForce-Plugin HELP';
          document.getElementById('helpFontColor').value = helpCfg.fontColor || '#ceb78b';
          document.getElementById('helpFontColorPicker').value = (helpCfg.fontColor || '#ceb78b').replace(/[^#0-9a-fA-F]/g, '').slice(0, 7) || '#ceb78b';
          document.getElementById('helpDescColor').value = helpCfg.descColor || '#eee';
          document.getElementById('helpDescColorPicker').value = (helpCfg.descColor || '#eeeeee').replace(/[^#0-9a-fA-F]/g, '').slice(0, 7) || '#eeeeee';
          const contBg = helpCfg.contBgColor || 'rgba(43, 52, 61, 0.8)';
          const headerBg = helpCfg.headerBgColor || 'rgba(34, 41, 51, .4)';
          const row1Bg = helpCfg.rowBgColor1 || 'rgba(34, 41, 51, .2)';
          const row2Bg = helpCfg.rowBgColor2 || 'rgba(34, 41, 51, .4)';
          const cellBg = helpCfg.cellBgColor || 'rgba(34, 41, 51, .35)';
          document.getElementById('helpContBgColor').value = contBg;
          document.getElementById('helpContBgColorPicker').value = toHex(contBg);
          document.getElementById('helpContBgAlpha').value = getAlpha(contBg);
          document.getElementById('helpContBgBlur').value = helpCfg.contBgBlur ?? 3;
          document.getElementById('helpContBgBlurValue').textContent = helpCfg.contBgBlur ?? 3;
          document.getElementById('helpHeaderBgColor').value = headerBg;
          document.getElementById('helpHeaderBgColorPicker').value = toHex(headerBg);
          document.getElementById('helpHeaderBgAlpha').value = getAlpha(headerBg);
          document.getElementById('helpRowBgColor1').value = row1Bg;
          document.getElementById('helpRowBgColor1Picker').value = toHex(row1Bg);
          document.getElementById('helpRowBgColor1Alpha').value = getAlpha(row1Bg);
          document.getElementById('helpRowBgColor2').value = row2Bg;
          document.getElementById('helpRowBgColor2Picker').value = toHex(row2Bg);
          document.getElementById('helpRowBgColor2Alpha').value = getAlpha(row2Bg);
          document.getElementById('helpCellBgColor').value = cellBg;
          document.getElementById('helpCellBgColorPicker').value = toHex(cellBg);
          document.getElementById('helpCellBgAlpha').value = getAlpha(cellBg);
          document.getElementById('helpFooterText').value = helpCfg.footerText || 'Created By Lengxi & Napcat-plugin-Delta-Force';
          document.getElementById('helpTitleFontSize').value = helpCfg.titleFontSize || '50px';
          document.getElementById('helpGroupFontSize').value = helpCfg.groupFontSize || '18px';
          document.getElementById('helpCommandFontSize').value = helpCfg.commandFontSize || '16px';
          document.getElementById('helpDescFontSize').value = helpCfg.descFontSize || '13px';

          // åŠ è½½å¸®åŠ©åˆ—è¡¨
          if (cfg.help_list) {
            helpListData = cfg.help_list;
          }
          // åŠ è½½å›¾ç‰‡çŠ¶æ€
          await loadHelpImageStatus();
          // æ¸²æŸ“å¸®åŠ©åˆ—è¡¨
          renderHelpList();

          // é«˜çº§è®¾ç½®
          setToggle('wsAutoConnect', cfg.websocket?.auto_connect);

          // API çŠ¶æ€
          if (cfg.api_key && cfg.api_key !== 'sk-xxxxxxx' && cfg.api_key !== '') {
            document.getElementById('statApi').innerHTML = '<span class="text-green-500">å·²é…ç½®</span>';
          } else {
            document.getElementById('statApi').innerHTML = '<span class="text-yellow-500">æœªé…ç½®</span>';
          }

          showToast('é…ç½®åŠ è½½æˆåŠŸ', 'success');
        }
      } catch (e) {
        showToast('åŠ è½½é…ç½®å¤±è´¥: ' + e.message, 'error');
      }
    }

    function arrayToString (arr) {
      if (!arr) return '';
      if (Array.isArray(arr)) return arr.join(',');
      return String(arr);
    }

    function stringToArray (str) {
      if (!str || str.trim() === '') return [];
      return str.split(',').map(s => s.trim()).filter(Boolean);
    }

    function setToggle (id, value) {
      const el = document.getElementById(id);
      if (el) value ? el.classList.add('active') : el.classList.remove('active');
    }

    function getToggle (id) {
      return document.getElementById(id)?.classList.contains('active') || false;
    }

    async function saveConfig () {
      const config = {
        api_key: document.getElementById('apiKey').value,
        clientID: document.getElementById('clientID').value,
        api_mode: document.getElementById('apiMode').value,
        command_prefix: document.getElementById('commandPrefix').value,
        puppeteer_plugin_id: document.getElementById('puppeteerId').value,

        push_daily_keyword: {
          enabled: getToggle('pushDailyKeyword'),
          cron: document.getElementById('pushDailyKeywordCron').value || '0 8 * * *',
          push_to: { group: stringToArray(document.getElementById('pushDailyKeywordGroups').value) }
        },
        push_daily_report: {
          enabled: getToggle('pushDailyReport'),
          cron: document.getElementById('pushDailyReportCron').value || '0 10 * * *',
          push_to: { group: stringToArray(document.getElementById('pushDailyReportGroups').value) }
        },
        push_weekly_report: {
          enabled: getToggle('pushWeeklyReport'),
          cron: document.getElementById('pushWeeklyReportCron').value || '0 10 * * 1',
          push_to: { group: stringToArray(document.getElementById('pushWeeklyReportGroups').value) }
        },
        push_place_status: {
          enabled: getToggle('pushPlaceStatus'),
          cron: document.getElementById('pushPlaceStatusCron').value || '*/5 * * * *',
          push_to: { group: stringToArray(document.getElementById('pushPlaceStatusGroups').value) }
        },

        broadcast_notification: {
          enabled: getToggle('broadcastEnabled'),
          push_to: {
            group: stringToArray(document.getElementById('broadcastGroups').value),
            private_enabled: getToggle('broadcastPrivateEnabled'),
            private: stringToArray(document.getElementById('broadcastPrivates').value)
          }
        },

        websocket: { auto_connect: getToggle('wsAutoConnect') },

        tts: {
          enabled: getToggle('ttsEnabled'),
          max_length: parseInt(document.getElementById('ttsMaxLength').value) || 800,
          mode: document.getElementById('ttsMode').value,
          group_list: stringToArray(document.getElementById('ttsGroupList').value),
          user_list: stringToArray(document.getElementById('ttsUserList').value),
          ai_tts: {
            enabled: getToggle('ttsAiEnabled'),
            mode: document.getElementById('ttsAiMode').value,
            group_list: stringToArray(document.getElementById('ttsAiGroupList').value),
            user_list: stringToArray(document.getElementById('ttsAiUserList').value)
          }
        },

        help_style: {
          title: document.getElementById('helpTitle').value || 'ä¸‰è§’æ´²è¡ŒåŠ¨ å¸®åŠ©',
          subTitle: document.getElementById('helpSubTitle').value || 'DeltaForce-Plugin HELP',
          fontColor: document.getElementById('helpFontColor').value || '#ceb78b',
          descColor: document.getElementById('helpDescColor').value || '#eee',
          contBgColor: document.getElementById('helpContBgColor').value || 'rgba(43, 52, 61, 0.8)',
          contBgBlur: parseFloat(document.getElementById('helpContBgBlur').value) || 3,
          headerBgColor: document.getElementById('helpHeaderBgColor').value || 'rgba(34, 41, 51, .4)',
          rowBgColor1: document.getElementById('helpRowBgColor1').value || 'rgba(34, 41, 51, .2)',
          rowBgColor2: document.getElementById('helpRowBgColor2').value || 'rgba(34, 41, 51, .4)',
          cellBgColor: document.getElementById('helpCellBgColor').value || 'rgba(34, 41, 51, .35)',
          footerText: document.getElementById('helpFooterText').value || '',
          titleFontSize: document.getElementById('helpTitleFontSize').value || '50px',
          groupFontSize: document.getElementById('helpGroupFontSize').value || '18px',
          commandFontSize: document.getElementById('helpCommandFontSize').value || '16px',
          descFontSize: document.getElementById('helpDescFontSize').value || '13px'
        },
        help_list: helpListData,

      };

      try {
        const res = await fetch(`${API_NO_AUTH}/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        const data = await res.json();
        showToast(data.code === 0 ? 'é…ç½®ä¿å­˜æˆåŠŸ' : 'ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), data.code === 0 ? 'success' : 'error');
      } catch (e) {
        showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
      }
    }

    // æ£€æµ‹æš—é»‘æ¨¡å¼
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      e.matches ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark');
    });

    // ç¼“å­˜ç¾¤åˆ—è¡¨å’Œå¥½å‹åˆ—è¡¨
    let groupsCache = [];
    let friendsCache = [];

    // è·å–ç¾¤åˆ—è¡¨
    async function loadGroupList () {
      try {
        const res = await fetch(`${API_NO_AUTH}/groups`);
        if (!res.ok) {
          console.error('è·å–ç¾¤åˆ—è¡¨HTTPé”™è¯¯:', res.status);
          return;
        }
        const data = await res.json();
        console.log('ç¾¤åˆ—è¡¨å“åº”:', data);
        if (data.code === 0 && Array.isArray(data.data)) {
          groupsCache = data.data;
          updateGroupSelectors();
          console.log(`å·²åŠ è½½ ${groupsCache.length} ä¸ªç¾¤`);
        } else {
          console.error('ç¾¤åˆ—è¡¨æ•°æ®æ ¼å¼é”™è¯¯:', data);
        }
      } catch (e) {
        console.error('è·å–ç¾¤åˆ—è¡¨å¤±è´¥:', e);
      }
    }

    // è·å–å¥½å‹åˆ—è¡¨
    async function loadFriendList () {
      try {
        const res = await fetch(`${API_NO_AUTH}/friends`);
        if (!res.ok) {
          console.error('è·å–å¥½å‹åˆ—è¡¨HTTPé”™è¯¯:', res.status);
          return;
        }
        const data = await res.json();
        console.log('å¥½å‹åˆ—è¡¨å“åº”:', data);
        if (data.code === 0 && Array.isArray(data.data)) {
          friendsCache = data.data;
          updateFriendSelectors();
          console.log(`å·²åŠ è½½ ${friendsCache.length} ä¸ªå¥½å‹`);
        } else {
          console.error('å¥½å‹åˆ—è¡¨æ•°æ®æ ¼å¼é”™è¯¯:', data);
        }
      } catch (e) {
        console.error('è·å–å¥½å‹åˆ—è¡¨å¤±è´¥:', e);
      }
    }

    // æ›´æ–°ç¾¤é€‰æ‹©å™¨ä¸‹æ‹‰æ¡†
    function updateGroupSelectors () {
      const selectors = document.querySelectorAll('.group-selector');
      selectors.forEach(sel => {
        sel.innerHTML = '<option value="">é€‰æ‹©ç¾¤...</option>';
        groupsCache.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.group_id;
          opt.textContent = `${g.group_name} (${g.group_id})`;
          sel.appendChild(opt);
        });
      });
    }

    // æ›´æ–°å¥½å‹é€‰æ‹©å™¨ä¸‹æ‹‰æ¡†
    function updateFriendSelectors () {
      const selectors = document.querySelectorAll('.friend-selector');
      selectors.forEach(sel => {
        sel.innerHTML = '<option value="">é€‰æ‹©å¥½å‹...</option>';
        friendsCache.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.user_id;
          opt.textContent = `${f.nickname || f.remark || 'æœªçŸ¥'} (${f.user_id})`;
          sel.appendChild(opt);
        });
      });
    }

    // æ·»åŠ ç¾¤åˆ°è¾“å…¥æ¡†
    function addGroupToInput (selectId, inputId) {
      const sel = document.getElementById(selectId);
      const input = document.getElementById(inputId);
      if (!sel.value) return;

      const current = input.value.split(',').map(s => s.trim()).filter(Boolean);
      if (!current.includes(sel.value)) {
        current.push(sel.value);
        input.value = current.join(',');
      }
      sel.value = '';
    }

    // æ·»åŠ å¥½å‹åˆ°è¾“å…¥æ¡†
    function addFriendToInput (selectId, inputId) {
      const sel = document.getElementById(selectId);
      const input = document.getElementById(inputId);
      if (!sel.value) return;

      const current = input.value.split(',').map(s => s.trim()).filter(Boolean);
      if (!current.includes(sel.value)) {
        current.push(sel.value);
        input.value = current.join(',');
      }
      sel.value = '';
    }

    // ==================== å¸®åŠ©åˆ—è¡¨ç¼–è¾‘åŠŸèƒ½ ====================

    // å¸®åŠ©åˆ—è¡¨æ•°æ®
    let helpListData = { left: [], right: [], fullWidth: [] };
    let currentEditItem = null;  // { position, groupIndex, itemIndex }
    let currentEditGroup = null; // { position, groupIndex }
    let confirmCallback = null;  // ç¡®è®¤å¼¹çª—å›è°ƒ
    let helpImageStatus = { hasCustomBg: false, hasCustomIcon: false }; // å›¾ç‰‡çŠ¶æ€

    // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
    function showConfirm (title, message, callback) {
      document.getElementById('confirmModalTitle').textContent = title;
      document.getElementById('confirmModalMessage').textContent = message;
      confirmCallback = callback;
      document.getElementById('confirmModal').classList.remove('hidden');
      document.getElementById('confirmModal').classList.add('flex');
    }

    // å…³é—­ç¡®è®¤å¼¹çª—
    function closeConfirmModal (confirmed) {
      document.getElementById('confirmModal').classList.add('hidden');
      document.getElementById('confirmModal').classList.remove('flex');
      if (confirmed && confirmCallback) {
        confirmCallback();
      }
      confirmCallback = null;
    }

    // é»˜è®¤å¸®åŠ©åˆ—è¡¨æ•°æ®
    function getDefaultHelpList () {
      const prefix = '^';
      return {
        fullWidth: [
          { order: 1, group: `æ‰€æœ‰å‘½ä»¤ç»Ÿä¸€ä½¿ç”¨ ${prefix} å‰ç¼€ï¼Œä¾‹å¦‚ ${prefix}å¸®åŠ©`, list: [] }
        ],
        left: [
          {
            order: 1, group: 'è´¦å·ç›¸å…³',
            list: [
              { icon: 80, title: `${prefix}è´¦å·`, desc: 'æŸ¥çœ‹å·²ç»‘å®štokenåˆ—è¡¨' },
              { icon: 71, title: `${prefix}è´¦å·åˆ‡æ¢ [åºå·]`, desc: 'æ¿€æ´»æŒ‡å®šåºå·è´¦å·' },
              { icon: 86, title: `${prefix}ç»‘å®š [token]`, desc: 'ç»‘å®štoken' },
              { icon: 48, title: `${prefix}è§£ç»‘ [åºå·]`, desc: 'è§£ç»‘æŒ‡å®šåºå·token' },
              { icon: 64, title: `${prefix}(QQ/å¾®ä¿¡)ç™»é™†`, desc: 'é€šè¿‡QQ/å¾®ä¿¡æ‰«ç ç™»å½•' },
              { icon: 78, title: `${prefix}ä¿¡æ¯`, desc: 'æŸ¥è¯¢ä¸ªäººè¯¦ç»†ä¿¡æ¯' },
            ]
          },
          {
            order: 2, group: 'æ¸¸æˆæ•°æ®',
            list: [
              { icon: 41, title: `${prefix}è—å“ [ç±»å‹]`, desc: 'æŸ¥è¯¢ä¸ªäººä»“åº“ä¸­çš„çš®è‚¤ã€é¥°å“ç­‰' },
              { icon: 48, title: `${prefix}è´§å¸`, desc: 'æŸ¥è¯¢æ¸¸æˆå†…è´§å¸ä¿¡æ¯' },
              { icon: 55, title: `${prefix}æ•°æ® [æ¨¡å¼] [èµ›å­£]`, desc: 'æŸ¥è¯¢ä¸ªäººç»Ÿè®¡æ•°æ®' },
              { icon: 66, title: `${prefix}æˆ˜ç»© [æ¨¡å¼] [é¡µç ]`, desc: 'æŸ¥è¯¢æˆ˜ç»©ï¼ˆå…¨é¢/çƒ½ç«ï¼‰' },
            ]
          },
        ],
        right: [
          {
            order: 1, group: 'æˆ˜æŠ¥ä¸æ¨é€',
            list: [
              { icon: 86, title: `${prefix}æ—¥æŠ¥ [æ¨¡å¼]`, desc: 'æŸ¥è¯¢æ—¥æŠ¥æ•°æ®ï¼ˆå…¨é¢/çƒ½ç«ï¼‰' },
              { icon: 86, title: `${prefix}å‘¨æŠ¥ [æ¨¡å¼]`, desc: 'æŸ¥è¯¢æ¯å‘¨æˆ˜æŠ¥' },
              { icon: 46, title: `${prefix}æ¯æ—¥å¯†ç `, desc: 'æŸ¥è¯¢ä»Šæ—¥å¯†ç ' },
            ]
          },
          {
            order: 2, group: 'å®ç”¨å·¥å…·',
            list: [
              { icon: 61, title: `${prefix}aié”è¯„ [æ¨¡å¼]`, desc: 'AIé”è¯„çƒ½ç«åœ°å¸¦å’Œå…¨é¢æˆ˜åœºæ•°æ®' },
              { icon: 48, title: `${prefix}ç‰¹å‹¤å¤„çŠ¶æ€`, desc: 'æŸ¥è¯¢ç‰¹å‹¤å¤„åˆ¶é€ çŠ¶æ€' },
              { icon: 78, title: `${prefix}å¹²å‘˜ [åç§°]`, desc: 'æŸ¥è¯¢å¹²å‘˜è¯¦ç»†ä¿¡æ¯' },
            ]
          },
        ]
      };
    }

    // è·å–å›¾æ ‡ CSS èƒŒæ™¯å®šä½ï¼ˆ30pxæ˜¾ç¤ºå°ºå¯¸ï¼ŒåŸå›¾50pxæ¯æ ¼ï¼‰
    // åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªå®šä¹‰å›¾æ ‡
    function isCustomIcon (icon) {
      return typeof icon === 'string' && icon.startsWith('custom:');
    }

    // è·å–å›¾æ ‡æ¸²æŸ“æ ·å¼ï¼ˆé¢„è§ˆç”¨ 30pxï¼‰
    function getIconStyle (icon, iconUrl) {
      if (isCustomIcon(icon)) {
        const name = icon.slice(7);
        return `background-image: url(${API_NO_AUTH}/help/custom-icon-file?name=${encodeURIComponent(name)}&t=${Date.now()}); background-size: contain; background-position: center; background-repeat: no-repeat;`;
      }
      if (!icon) return 'display:none';
      const x = (icon - 1) % 10;
      const y = Math.floor((icon - 1) / 10);
      return `background-image: url(${iconUrl}); background-position:-${x * 30}px -${y * 30}px`;
    }

    // è·å–å›¾æ ‡é€‰æ‹©å™¨é¡¹çš„CSSï¼ˆ32pxæ˜¾ç¤ºï¼Œä»…ç²¾çµå›¾ç”¨ï¼‰
    function getIconPickerCss (icon) {
      if (icon < 1) return 'display:none';
      const x = (icon - 1) % 10;
      const y = Math.floor((icon - 1) / 10);
      return `background-position:-${x * 32}px -${y * 32}px`;
    }

    // æ¸²æŸ“å¸®åŠ©åˆ—è¡¨ï¼ˆæ¨¡æ‹ŸçœŸå®å¸®åŠ©å›¾æ ·å¼ï¼‰
    function renderHelpList () {
      const fontColor = document.getElementById('helpFontColor')?.value || '#ceb78b';
      const descColor = document.getElementById('helpDescColor')?.value || '#eee';
      const contBgColor = document.getElementById('helpContBgColor')?.value || 'rgba(43, 52, 61, 0.8)';
      const headerBgColor = document.getElementById('helpHeaderBgColor')?.value || 'rgba(34, 41, 51, .4)';
      const rowBgColor1 = document.getElementById('helpRowBgColor1')?.value || 'rgba(34, 41, 51, .2)';
      const rowBgColor2 = document.getElementById('helpRowBgColor2')?.value || 'rgba(34, 41, 51, .4)';
      const cellBgColor = document.getElementById('helpCellBgColor')?.value || 'rgba(34, 41, 51, .35)';

      // æ›´æ–°æ ‡é¢˜
      const title = document.getElementById('helpTitle')?.value || 'ä¸‰è§’æ´²è¡ŒåŠ¨ å¸®åŠ©';
      const subTitle = document.getElementById('helpSubTitle')?.value || 'DeltaForce-Plugin HELP';
      document.getElementById('helpPreviewTitle').textContent = title;
      document.getElementById('helpPreviewTitle').style.color = fontColor;
      document.getElementById('helpPreviewSubtitle').textContent = subTitle;
      document.getElementById('helpPreviewSubtitle').style.color = fontColor;

      // åŠ è½½èƒŒæ™¯å›¾ï¼ˆæ ¹æ®å›¾ç‰‡çŠ¶æ€ä½¿ç”¨è‡ªå®šä¹‰æˆ–é»˜è®¤ï¼‰
      const timestamp = Date.now();
      const bgUrl = helpImageStatus.hasCustomBg
        ? `${API_NO_AUTH}/help/custom-image?type=bg&t=${timestamp}`
        : `${STATIC_FILES}/help/imgs/default/bg.jpg`;
      document.getElementById('helpPreviewWrap').style.backgroundImage = `url(${bgUrl})`;

      const styleOpts = { fontColor, descColor, contBgColor, headerBgColor, rowBgColor1, rowBgColor2, cellBgColor };

      // æ¸²æŸ“å…¨å®½åˆ†ç»„
      let fullWidthHtml = '';
      if (helpListData.fullWidth && helpListData.fullWidth.length > 0) {
        helpListData.fullWidth.forEach((group, gIdx) => {
          fullWidthHtml += renderGroupPreview(group, 'fullWidth', gIdx, styleOpts, 4);
        });
      }
      document.getElementById('helpFullWidthContainer').innerHTML = fullWidthHtml;

      // æ¸²æŸ“å·¦åˆ—
      let leftHtml = '';
      if (helpListData.left) {
        helpListData.left.sort((a, b) => (a.order || 99) - (b.order || 99)).forEach((group, gIdx) => {
          leftHtml += renderGroupPreview(group, 'left', gIdx, styleOpts, 2);
        });
      }
      leftHtml += `<div class="help-preview-add-group" onclick="addHelpGroup('left')">+ æ·»åŠ åˆ†ç»„</div>`;
      document.getElementById('helpLeftColumn').innerHTML = leftHtml;

      // æ¸²æŸ“å³åˆ—
      let rightHtml = '';
      if (helpListData.right) {
        helpListData.right.sort((a, b) => (a.order || 99) - (b.order || 99)).forEach((group, gIdx) => {
          rightHtml += renderGroupPreview(group, 'right', gIdx, styleOpts, 2);
        });
      }
      rightHtml += `<div class="help-preview-add-group" onclick="addHelpGroup('right')">+ æ·»åŠ åˆ†ç»„</div>`;
      document.getElementById('helpRightColumn').innerHTML = rightHtml;

      // åº•æ æ–‡æœ¬
      const defaultFooter = 'Created By Lengxi & Napcat-plugin-Delta-Force';
      const footerText = document.getElementById('helpFooterText')?.value || defaultFooter;
      const footerEl = document.getElementById('helpPreviewFooter');
      if (footerEl) {
        footerEl.textContent = footerText;
        footerEl.style.color = `${fontColor}99`;
      }
    }

    // æ¸²æŸ“å•ä¸ªåˆ†ç»„ï¼ˆæ¨¡æ‹ŸçœŸå®æ ·å¼ï¼‰
    function renderGroupPreview (group, position, gIdx, s, colCount) {
      const timestamp = Date.now();
      const iconUrl = helpImageStatus.hasCustomIcon
        ? `${API_NO_AUTH}/help/custom-image?type=icon&t=${timestamp}`
        : `${STATIC_FILES}/help/imgs/default/icon.png`;
      let html = `
        <div class="help-preview-group" style="background: ${s.contBgColor}; backdrop-filter: blur(3px);">
          <div class="help-preview-group-title" style="background: ${s.headerBgColor}; color: ${s.fontColor};" 
               onclick="openGroupEditModal('${position}', ${gIdx})">
            <span>${group.group}</span>
            <span style="font-size: 11px; opacity: 0.6;">ç‚¹å‡»ç¼–è¾‘</span>
          </div>
          <div class="help-preview-table">
      `;

      if (group.list && group.list.length > 0) {
        for (let i = 0; i < group.list.length; i += colCount) {
          html += '<div class="help-preview-row">';
          for (let j = 0; j < colCount; j++) {
            const idx = i + j;
            const rowBg = Math.floor(i / colCount) % 2 === 0 ? s.rowBgColor1 : s.rowBgColor2;
            if (idx < group.list.length) {
              const item = group.list[idx];
              html += `
                <div class="help-preview-cell" style="background: ${s.cellBgColor};" 
                     onclick="openHelpEditModal('${position}', ${gIdx}, ${idx})">
                  <span class="help-preview-icon" style="${getIconStyle(item.icon, iconUrl)}"></span>
                  <div class="help-preview-cell-title" style="color: ${s.fontColor};">${item.title}</div>
                  <div class="help-preview-cell-desc" style="color: ${s.descColor};">${item.desc}</div>
                </div>
              `;
            } else {
              html += `<div class="help-preview-cell" style="background: ${s.cellBgColor}; cursor: default;"></div>`;
            }
          }
          html += '</div>';
        }
      }

      // æ·»åŠ æŒ‰é’®è¡Œ
      html += `
        <div class="help-preview-row">
          <div class="help-preview-add-cell" style="width: 100%;" onclick="addHelpItem('${position}', ${gIdx})">
            + æ·»åŠ å‘½ä»¤
          </div>
        </div>
      `;

      html += '</div></div>';
      return html;
    }

    // åˆå§‹åŒ–å›¾æ ‡é€‰æ‹©å™¨
    let customIconList = []; // è‡ªå®šä¹‰å›¾æ ‡æ–‡ä»¶ååˆ—è¡¨

    async function loadCustomIcons () {
      try {
        const res = await fetch(`${API_NO_AUTH}/help/custom-icons`);
        if (res.ok) {
          const data = await res.json();
          if (data.code === 0) customIconList = data.data || [];
        }
      } catch { /* ignore */ }
    }

    async function initIconPicker (selectedIcon) {
      await loadCustomIcons();
      const grid = document.getElementById('iconPickerGrid');
      const timestamp = Date.now();
      const iconUrl = helpImageStatus.hasCustomIcon
        ? `${API_NO_AUTH}/help/custom-image?type=icon&t=${timestamp}`
        : `${STATIC_FILES}/help/imgs/default/icon.png`;
      let html = '';

      // è‡ªå®šä¹‰å›¾æ ‡åŒºåŸŸ
      if (customIconList.length > 0) {
        html += '<div style="grid-column:1/-1;font-size:11px;color:#888;padding:2px 0;">è‡ªå®šä¹‰å›¾æ ‡</div>';
        customIconList.forEach(name => {
          const val = 'custom:' + name;
          const isSelected = selectedIcon === val ? 'selected' : '';
          html += `<div class="icon-picker-item ${isSelected}" data-icon="${val}"
                        style="background-image: url(${API_NO_AUTH}/help/custom-icon-file?name=${encodeURIComponent(name)}&t=${timestamp}); background-size: contain; background-position: center; background-repeat: no-repeat;"
                        onclick="selectIcon('${val}')">
                    <span class="icon-delete-btn" onclick="event.stopPropagation();deleteCustomIcon('${name}')">&times;</span>
                  </div>`;
        });
        html += '<div style="grid-column:1/-1;font-size:11px;color:#888;padding:2px 0;margin-top:4px;">é»˜è®¤ç²¾çµå›¾</div>';
      }

      // é»˜è®¤ç²¾çµå›¾å›¾æ ‡
      for (let i = 1; i <= 100; i++) {
        const isSelected = i === selectedIcon ? 'selected' : '';
        html += `<div class="icon-picker-item ${isSelected}" 
                      style="background-image: url(${iconUrl}); ${getIconPickerCss(i)}"
                      onclick="selectIcon(${i})" data-icon="${i}"></div>`;
      }

      // ä¸Šä¼ è‡ªå®šä¹‰å›¾æ ‡æŒ‰é’®
      html += `<div style="grid-column:1/-1;margin-top:6px;">
        <input type="file" id="customIconUpload" accept="image/png,image/jpg,image/jpeg,image/webp" class="hidden" onchange="uploadCustomIcon()">
        <button onclick="document.getElementById('customIconUpload').click()" class="btn text-xs px-3 py-1.5 w-full border border-dashed border-gray-400 text-gray-500 hover:text-blue-500 hover:border-blue-400">+ ä¸Šä¼ è‡ªå®šä¹‰å›¾æ ‡</button>
      </div>`;

      grid.innerHTML = html;
    }

    // é€‰æ‹©å›¾æ ‡ï¼ˆæ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
    function selectIcon (icon) {
      document.getElementById('editHelpIcon').value = typeof icon === 'string' ? icon : String(icon);
      document.querySelectorAll('.icon-picker-item').forEach(el => el.classList.remove('selected'));
      document.querySelector(`.icon-picker-item[data-icon="${icon}"]`)?.classList.add('selected');
    }

    // ä¸Šä¼ è‡ªå®šä¹‰å›¾æ ‡
    async function uploadCustomIcon () {
      const input = document.getElementById('customIconUpload');
      const file = input.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { showToast('å›¾æ ‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡2MB', 'error'); return; }

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const bytes = new Uint8Array(e.target.result);
          let binary = '';
          for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
          const base64 = btoa(binary);
          const CHUNK_SIZE = 50000;
          const totalChunks = Math.ceil(base64.length / CHUNK_SIZE);
          const name = file.name;

          for (let i = 0; i < totalChunks; i++) {
            const chunk = base64.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
            const res = await fetch(`${API_NO_AUTH}/help/upload-icon-chunk`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, chunkIndex: i, totalChunks, data: chunk })
            });
            const data = await res.json();
            if (data.code !== 0) { showToast('å›¾æ ‡ä¸Šä¼ å¤±è´¥: ' + data.message, 'error'); return; }
            if (data.done) {
              showToast('å›¾æ ‡ä¸Šä¼ æˆåŠŸ', 'success');
              selectIcon('custom:' + data.fileName);
              initIconPicker('custom:' + data.fileName);
            }
          }
        } catch (err) { showToast('ä¸Šä¼ å¤±è´¥: ' + err.message, 'error'); }
      };
      reader.readAsArrayBuffer(file);
      input.value = '';
    }

    // åˆ é™¤è‡ªå®šä¹‰å›¾æ ‡
    async function deleteCustomIcon (name) {
      try {
        const res = await fetch(`${API_NO_AUTH}/help/delete-icon`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const data = await res.json();
        if (data.code === 0) {
          showToast('å›¾æ ‡å·²åˆ é™¤', 'success');
          const currentIcon = document.getElementById('editHelpIcon').value;
          initIconPicker(currentIcon === 'custom:' + name ? 80 : currentIcon);
        }
      } catch (err) { showToast('åˆ é™¤å¤±è´¥: ' + err.message, 'error'); }
    }

    // æ‰“å¼€æ ‡é¢˜ç¼–è¾‘å¼¹çª—
    // æ ·å¼é…ç½®å¼¹çª—
    function openStyleConfigModal () {
      document.getElementById('styleConfigModal').classList.remove('hidden');
      document.getElementById('styleConfigModal').classList.add('flex');
    }
    function closeStyleConfigModal () {
      document.getElementById('styleConfigModal').classList.remove('flex');
      document.getElementById('styleConfigModal').classList.add('hidden');
    }

    // åº•æ æ–‡æœ¬ç¼–è¾‘
    function openFooterEditModal () {
      const footerText = document.getElementById('helpFooterText').value || '';
      document.getElementById('editHelpTitle').value = footerText;
      document.getElementById('editHelpDesc').value = '';
      document.getElementById('editHelpDesc').parentElement.style.display = 'none';
      document.getElementById('iconPickerSection').style.display = 'none';
      document.getElementById('helpEditModalTitle').textContent = 'ç¼–è¾‘åº•æ æ–‡æœ¬';
      currentEditItem = { type: 'footer' };
      document.getElementById('helpEditModal').classList.remove('hidden');
      document.getElementById('helpEditModal').classList.add('flex');
    }

    function openTitleEditModal () {
      const title = document.getElementById('helpPreviewTitle').textContent;
      const subTitle = document.getElementById('helpPreviewSubtitle').textContent;

      document.getElementById('editHelpTitle').value = title;
      document.getElementById('editHelpDesc').value = subTitle;
      document.getElementById('iconPickerSection').style.display = 'none';
      document.getElementById('helpEditModalTitle').textContent = 'ç¼–è¾‘æ ‡é¢˜';

      currentEditItem = { type: 'title' };

      document.getElementById('helpEditModal').classList.remove('hidden');
      document.getElementById('helpEditModal').classList.add('flex');
    }

    // æ‰“å¼€å¸®åŠ©é¡¹ç¼–è¾‘å¼¹çª—
    function openHelpEditModal (position, groupIndex, itemIndex) {
      currentEditItem = { position, groupIndex, itemIndex };
      const item = helpListData[position][groupIndex].list[itemIndex];

      document.getElementById('editHelpIcon').value = item.icon || 80;
      document.getElementById('iconPickerSection').style.display = 'block';
      initIconPicker(item.icon || 80);
      document.getElementById('editHelpTitle').value = item.title || '';
      document.getElementById('editHelpDesc').value = item.desc || '';
      document.getElementById('helpEditModalTitle').textContent = 'ç¼–è¾‘å¸®åŠ©é¡¹';

      document.getElementById('helpEditModal').classList.remove('hidden');
      document.getElementById('helpEditModal').classList.add('flex');
    }

    // å…³é—­å¸®åŠ©é¡¹ç¼–è¾‘å¼¹çª—
    function closeHelpEditModal () {
      document.getElementById('helpEditModal').classList.add('hidden');
      document.getElementById('helpEditModal').classList.remove('flex');
      document.getElementById('iconPickerSection').style.display = 'block';
      document.getElementById('editHelpDesc').parentElement.style.display = '';
      currentEditItem = null;
    }

    // ä¿å­˜å¸®åŠ©é¡¹
    function saveHelpItem () {
      if (!currentEditItem) return;

      // å¤„ç†åº•æ ç¼–è¾‘
      if (currentEditItem.type === 'footer') {
        document.getElementById('helpFooterText').value = document.getElementById('editHelpTitle').value;
        renderHelpList();
        closeHelpEditModal();
        return;
      }

      // å¤„ç†æ ‡é¢˜ç¼–è¾‘
      if (currentEditItem.type === 'title') {
        document.getElementById('helpTitle').value = document.getElementById('editHelpTitle').value;
        document.getElementById('helpSubTitle').value = document.getElementById('editHelpDesc').value;
        renderHelpList();
        closeHelpEditModal();
        return;
      }

      const { position, groupIndex, itemIndex } = currentEditItem;

      // è§£æå›¾æ ‡å€¼ï¼ˆæ•°å­—æˆ–è‡ªå®šä¹‰å­—ç¬¦ä¸²ï¼‰
      const iconVal = document.getElementById('editHelpIcon').value;
      const icon = iconVal.startsWith('custom:') ? iconVal : (parseInt(iconVal) || 0);

      if (itemIndex === -1) {
        // æ–°å¢
        helpListData[position][groupIndex].list.push({
          icon,
          title: document.getElementById('editHelpTitle').value,
          desc: document.getElementById('editHelpDesc').value
        });
      } else {
        // ç¼–è¾‘
        helpListData[position][groupIndex].list[itemIndex] = {
          icon,
          title: document.getElementById('editHelpTitle').value,
          desc: document.getElementById('editHelpDesc').value
        };
      }

      renderHelpList();
      closeHelpEditModal();
    }

    // åˆ é™¤å¸®åŠ©é¡¹
    function deleteHelpItem () {
      if (!currentEditItem) return;

      // æ ‡é¢˜ä¸èƒ½åˆ é™¤
      if (currentEditItem.type === 'title') {
        closeHelpEditModal();
        return;
      }

      if (currentEditItem.itemIndex === -1) return;
      const { position, groupIndex, itemIndex } = currentEditItem;

      showConfirm('åˆ é™¤å¸®åŠ©é¡¹', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸®åŠ©é¡¹å—ï¼Ÿ', () => {
        helpListData[position][groupIndex].list.splice(itemIndex, 1);
        renderHelpList();
        showToast('å·²åˆ é™¤å¸®åŠ©é¡¹', 'success');
        closeHelpEditModal();
      });
    }

    // æ·»åŠ å¸®åŠ©é¡¹
    function addHelpItem (position, groupIndex) {
      currentEditItem = { position, groupIndex, itemIndex: -1 };

      document.getElementById('editHelpIcon').value = 80;
      document.getElementById('iconPickerSection').style.display = 'block';
      initIconPicker(80);
      document.getElementById('editHelpTitle').value = '';
      document.getElementById('editHelpDesc').value = '';
      document.getElementById('helpEditModalTitle').textContent = 'æ·»åŠ å¸®åŠ©é¡¹';

      document.getElementById('helpEditModal').classList.remove('hidden');
      document.getElementById('helpEditModal').classList.add('flex');
    }

    // æ‰“å¼€åˆ†ç»„ç¼–è¾‘å¼¹çª—
    function openGroupEditModal (position, groupIndex) {
      currentEditGroup = { position, groupIndex };
      const group = helpListData[position][groupIndex];

      document.getElementById('editGroupName').value = group.group || '';
      document.getElementById('editGroupOrder').value = group.order || 1;
      document.getElementById('editGroupPosition').value = position;

      document.getElementById('groupEditModal').classList.remove('hidden');
      document.getElementById('groupEditModal').classList.add('flex');
    }

    // å…³é—­åˆ†ç»„ç¼–è¾‘å¼¹çª—
    function closeGroupEditModal () {
      document.getElementById('groupEditModal').classList.add('hidden');
      document.getElementById('groupEditModal').classList.remove('flex');
      currentEditGroup = null;
    }

    // ä¿å­˜åˆ†ç»„
    function saveHelpGroup () {
      if (!currentEditGroup) return;
      const { position, groupIndex } = currentEditGroup;
      const newPosition = document.getElementById('editGroupPosition').value;

      const groupData = {
        ...helpListData[position][groupIndex],
        group: document.getElementById('editGroupName').value,
        order: parseInt(document.getElementById('editGroupOrder').value) || 1
      };

      if (position !== newPosition) {
        // ç§»åŠ¨åˆ°æ–°ä½ç½®
        helpListData[position].splice(groupIndex, 1);
        helpListData[newPosition].push(groupData);
      } else {
        helpListData[position][groupIndex] = groupData;
      }

      renderHelpList();
      closeGroupEditModal();
    }

    // åˆ é™¤åˆ†ç»„
    function deleteHelpGroup () {
      if (!currentEditGroup) return;
      const { position, groupIndex } = currentEditGroup;

      showConfirm('åˆ é™¤åˆ†ç»„', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç»„åŠå…¶æ‰€æœ‰å¸®åŠ©é¡¹å—ï¼Ÿ', () => {
        helpListData[position].splice(groupIndex, 1);
        renderHelpList();
        showToast('å·²åˆ é™¤åˆ†ç»„', 'success');
        closeGroupEditModal();
      });
    }

    // æ·»åŠ åˆ†ç»„
    function addHelpGroup (position = 'left') {
      helpListData[position].push({
        order: helpListData[position].length + 1,
        group: 'æ–°åˆ†ç»„',
        list: []
      });
      renderHelpList();
    }

    // å°†èƒŒæ™¯è‰²çš„ alpha å€¼ä¹˜ä»¥é€æ˜åº¦ç³»æ•°ï¼Œåªå½±å“èƒŒæ™¯ä¸å½±å“æ–‡å­—
    function applyAlpha (colorStr, opacity) {
      const op = parseFloat(opacity);
      if (!colorStr || isNaN(op)) return colorStr;
      // è§£æ rgba
      const rgbaM = colorStr.match(/rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([\d.]+)\s*\)/);
      if (rgbaM) {
        return `rgba(${rgbaM[1]}, ${rgbaM[2]}, ${rgbaM[3]}, ${(parseFloat(rgbaM[4]) * op).toFixed(2)})`;
      }
      // è§£æ rgb
      const rgbM = colorStr.match(/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);
      if (rgbM) {
        return `rgba(${rgbM[1]}, ${rgbM[2]}, ${rgbM[3]}, ${op})`;
      }
      // hex
      if (/^#[0-9a-fA-F]{6}$/.test(colorStr)) {
        const r = parseInt(colorStr.slice(1, 3), 16);
        const g = parseInt(colorStr.slice(3, 5), 16);
        const b = parseInt(colorStr.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${op})`;
      }
      return colorStr;
    }

    // rgba/hex è½¬ hexï¼ˆç”¨äº color pickerï¼‰
    function toHex (colorStr) {
      if (!colorStr) return '#000000';
      // å¦‚æœå·²ç»æ˜¯ #hex
      if (/^#[0-9A-Fa-f]{6}$/.test(colorStr)) return colorStr;
      if (/^#[0-9A-Fa-f]{3}$/.test(colorStr)) {
        return '#' + colorStr[1] + colorStr[1] + colorStr[2] + colorStr[2] + colorStr[3] + colorStr[3];
      }
      // è§£æ rgba/rgb
      const m = colorStr.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);
      if (m) {
        return '#' + [m[1], m[2], m[3]].map(n => parseInt(n).toString(16).padStart(2, '0')).join('');
      }
      return '#000000';
    }

    // hex è½¬ rgb æ•°å€¼
    function hexToRgb (hex) {
      const h = hex.replace('#', '');
      return {
        r: parseInt(h.substring(0, 2), 16),
        g: parseInt(h.substring(2, 4), 16),
        b: parseInt(h.substring(4, 6), 16)
      };
    }

    // ä» rgba å­—ç¬¦ä¸²æå– alpha
    function getAlpha (colorStr) {
      const m = colorStr.match(/rgba\([^)]*,\s*([\d.]+)\s*\)/);
      return m ? parseFloat(m[1]) : 1;
    }

    // é¢œè‰²é€‰æ‹©å™¨åŒæ­¥ï¼ˆçº¯è‰²ç”¨ï¼Œå¦‚æ–‡å­—é¢œè‰²ï¼Œæ— é€æ˜åº¦æ»‘å—ï¼‰
    function syncColorPicker (pickerId, inputId) {
      const picker = document.getElementById(pickerId);
      const input = document.getElementById(inputId);
      if (!picker || !input) return;
      picker.addEventListener('input', () => {
        input.value = picker.value;
        renderHelpList();
      });
      input.addEventListener('input', () => {
        try { picker.value = toHex(input.value); } catch { }
        renderHelpList();
      });
    }

    // å¸¦é€æ˜åº¦æ»‘å—çš„é¢œè‰²åŒæ­¥ï¼ˆåº•è‰²ç”¨ï¼‰
    function syncBgColorPicker (pickerId, inputId, alphaId) {
      const picker = document.getElementById(pickerId);
      const input = document.getElementById(inputId);
      const alpha = document.getElementById(alphaId);
      if (!picker || !input || !alpha) return;

      // ä»å½“å‰æ–‡æœ¬æ¡†å€¼åŒæ­¥è‰²ç›˜å’Œæ»‘å—
      function syncFromInput () {
        try { picker.value = toHex(input.value); } catch { }
        alpha.value = getAlpha(input.value);
      }

      // ç”¨è‰²ç›˜å’Œæ»‘å—çš„å€¼ç»„åˆå†™å…¥æ–‡æœ¬æ¡†
      function writeToInput () {
        const rgb = hexToRgb(picker.value);
        input.value = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha.value})`;
        renderHelpList();
      }

      picker.addEventListener('input', writeToInput);
      alpha.addEventListener('input', writeToInput);
      input.addEventListener('input', () => { syncFromInput(); renderHelpList(); });
    }

    // ä¸ºè¾“å…¥æ¡†ç»‘å®šå®æ—¶é¢„è§ˆ
    function bindLivePreview (elementId) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.addEventListener('input', () => renderHelpList());
    }

    // åˆå§‹åŒ–å¸®åŠ©è®¾ç½®äº‹ä»¶
    function initHelpSettings () {
      // æ–‡å­—é¢œè‰²ï¼ˆçº¯è‰²ï¼‰
      syncColorPicker('helpFontColorPicker', 'helpFontColor');
      syncColorPicker('helpDescColorPicker', 'helpDescColor');
      // åº•è‰²ï¼ˆå¸¦ç‹¬ç«‹é€æ˜åº¦ï¼‰
      syncBgColorPicker('helpContBgColorPicker', 'helpContBgColor', 'helpContBgAlpha');
      syncBgColorPicker('helpHeaderBgColorPicker', 'helpHeaderBgColor', 'helpHeaderBgAlpha');
      syncBgColorPicker('helpRowBgColor1Picker', 'helpRowBgColor1', 'helpRowBgColor1Alpha');
      syncBgColorPicker('helpRowBgColor2Picker', 'helpRowBgColor2', 'helpRowBgColor2Alpha');
      syncBgColorPicker('helpCellBgColorPicker', 'helpCellBgColor', 'helpCellBgAlpha');

      // æ¨¡ç³Šåº¦æ»‘å—
      const blurSlider = document.getElementById('helpContBgBlur');
      const blurValue = document.getElementById('helpContBgBlurValue');
      if (blurSlider && blurValue) {
        blurSlider.addEventListener('input', () => {
          blurValue.textContent = blurSlider.value;
          renderHelpList();
        });
      }

      // å­—ä½“è¾“å…¥æ¡†ç»‘å®šå®æ—¶é¢„è§ˆ
      ['helpTitleFontSize', 'helpGroupFontSize', 'helpCommandFontSize', 'helpDescFontSize'
      ].forEach(bindLivePreview);

      // åŠ è½½å¸®åŠ©åˆ—è¡¨
      loadHelpListData();
    }

    // åŠ è½½å¸®åŠ©å›¾ç‰‡çŠ¶æ€
    async function loadHelpImageStatus () {
      try {
        const res = await fetch(`${API_NO_AUTH}/help/image-status`);
        if (res.ok) {
          const data = await res.json();
          if (data.code === 0 && data.data) {
            helpImageStatus = data.data;
          }
        }
      } catch (e) {
        console.log('åŠ è½½å›¾ç‰‡çŠ¶æ€å¤±è´¥');
      }
      // æ›´æ–°é¢„è§ˆ
      updateImagePreviews();
    }

    // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
    function updateImagePreviews () {
      const timestamp = Date.now();
      const bgUrl = helpImageStatus.hasCustomBg
        ? `${API_NO_AUTH}/help/custom-image?type=bg&t=${timestamp}`
        : `${STATIC_FILES}/help/imgs/default/bg.jpg`;
      const iconUrl = helpImageStatus.hasCustomIcon
        ? `${API_NO_AUTH}/help/custom-image?type=icon&t=${timestamp}`
        : `${STATIC_FILES}/help/imgs/default/icon.png`;

      document.getElementById('bgPreview').style.backgroundImage = `url(${bgUrl})`;
    }

    // åŠ è½½å¸®åŠ©åˆ—è¡¨æ•°æ®
    async function loadHelpListData () {
      try {
        const res = await fetch(`${API_NO_AUTH}/help/list`);
        if (res.ok) {
          const data = await res.json();
          if (data.code === 0 && data.data) {
            helpListData = data.data;
          } else {
            helpListData = getDefaultHelpList();
          }
        } else {
          helpListData = getDefaultHelpList();
        }
      } catch (e) {
        console.log('åŠ è½½å¸®åŠ©åˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
        helpListData = getDefaultHelpList();
      }
      renderHelpList();
    }

    // æ¢å¤åˆå§‹èœå•
    function resetHelpList () {
      showConfirm('æ¢å¤åˆå§‹èœå•', 'ç¡®å®šè¦æ¢å¤åˆå§‹èœå•å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰è‡ªå®šä¹‰ä¿®æ”¹ï¼ˆåŒ…æ‹¬æ ·å¼ï¼‰ã€‚', async () => {
        try {
          const res = await fetch(`${API_NO_AUTH}/help/default`);
          if (res.ok) {
            const data = await res.json();
            if (data.code === 0 && data.data) {
              helpListData = data.data;
              // é‡ç½®æ ‡é¢˜
              document.getElementById('helpTitle').value = 'ä¸‰è§’æ´²è¡ŒåŠ¨ å¸®åŠ©';
              document.getElementById('helpSubTitle').value = 'DeltaForce-Plugin HELP';
              // é‡ç½®åº•æ 
              document.getElementById('helpFooterText').value = 'Created By Lengxi & Napcat-plugin-Delta-Force';
              // é‡ç½®æ ·å¼
              document.getElementById('helpFontColor').value = '#ceb78b';
              document.getElementById('helpFontColorPicker').value = '#ceb78b';
              document.getElementById('helpDescColor').value = '#eee';
              document.getElementById('helpDescColorPicker').value = '#eeeeee';
              document.getElementById('helpContBgColor').value = 'rgba(43, 52, 61, 0.8)';
              document.getElementById('helpContBgColorPicker').value = '#2b343d';
              document.getElementById('helpContBgAlpha').value = 0.8;
              document.getElementById('helpContBgBlur').value = 3;
              document.getElementById('helpContBgBlurValue').textContent = '3';
              document.getElementById('helpHeaderBgColor').value = 'rgba(34, 41, 51, 0.4)';
              document.getElementById('helpHeaderBgColorPicker').value = '#222933';
              document.getElementById('helpHeaderBgAlpha').value = 0.4;
              document.getElementById('helpRowBgColor1').value = 'rgba(34, 41, 51, 0.2)';
              document.getElementById('helpRowBgColor1Picker').value = '#222933';
              document.getElementById('helpRowBgColor1Alpha').value = 0.2;
              document.getElementById('helpRowBgColor2').value = 'rgba(34, 41, 51, 0.4)';
              document.getElementById('helpRowBgColor2Picker').value = '#222933';
              document.getElementById('helpRowBgColor2Alpha').value = 0.4;
              document.getElementById('helpCellBgColor').value = 'rgba(34, 41, 51, 0.35)';
              document.getElementById('helpCellBgColorPicker').value = '#222933';
              document.getElementById('helpCellBgAlpha').value = 0.35;
              document.getElementById('helpTitleFontSize').value = '50px';
              document.getElementById('helpGroupFontSize').value = '18px';
              document.getElementById('helpCommandFontSize').value = '16px';
              document.getElementById('helpDescFontSize').value = '13px';

              renderHelpList();
              showToast('å·²æ¢å¤åˆå§‹èœå•ï¼Œè¯·ä¿å­˜é…ç½®ç”Ÿæ•ˆ', 'success');
            }
          }
        } catch (e) {
          showToast('æ¢å¤å¤±è´¥: ' + e.message, 'error');
        }
      });
    }

    // ä¸Šä¼ å¸®åŠ©å›¾ç‰‡ï¼ˆbase64æ–¹å¼ï¼‰
    async function uploadHelpImage (type) {
      const input = document.getElementById(type + 'Upload');
      const file = input.files[0];
      if (!file) return;

      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
      if (file.size > 5 * 1024 * 1024) {
        showToast('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
        return;
      }

      showToast('æ­£åœ¨ä¸Šä¼ ...', 'info');

      // è¯»å–ä¸º ArrayBuffer å†è½¬ base64ï¼ˆä¸å« data:... å‰ç¼€ï¼‰
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const arrayBuffer = e.target.result;
          const bytes = new Uint8Array(arrayBuffer);
          let binary = '';
          for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          const base64 = btoa(binary);

          // åˆ†å—ä¸Šä¼ ï¼ˆæ¯å— 50KB base64 æ–‡æœ¬ï¼‰
          const CHUNK_SIZE = 50000;
          const totalChunks = Math.ceil(base64.length / CHUNK_SIZE);

          for (let i = 0; i < totalChunks; i++) {
            const chunk = base64.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
            const res = await fetch(`${API_NO_AUTH}/help/upload-chunk`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                type: type,
                chunkIndex: i,
                totalChunks: totalChunks,
                data: chunk
              })
            });
            const data = await res.json();
            if (data.code !== 0) {
              showToast('ä¸Šä¼ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
              return;
            }
            if (data.done) {
              showToast(`${type === 'bg' ? 'èƒŒæ™¯å›¾' : 'å›¾æ ‡'}ä¸Šä¼ æˆåŠŸ`, 'success');
              if (type === 'bg') {
                helpImageStatus.hasCustomBg = true;
              } else {
                helpImageStatus.hasCustomIcon = true;
              }
              updateImagePreviews();
              renderHelpList();
            }
          }
        } catch (err) {
          showToast('ä¸Šä¼ å¤±è´¥: ' + err.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      input.value = '';
    }

    // é‡ç½®å¸®åŠ©å›¾ç‰‡
    async function resetHelpImage (type) {
      try {
        const res = await fetch(`${API_NO_AUTH}/help/reset-image?type=${type}`, { method: 'POST' });
        const data = await res.json();
        if (data.code === 0) {
          showToast(`${type === 'bg' ? 'èƒŒæ™¯å›¾' : 'å›¾æ ‡'}å·²é‡ç½®`, 'success');
          // æ›´æ–°å›¾ç‰‡çŠ¶æ€
          if (type === 'bg') {
            helpImageStatus.hasCustomBg = false;
          } else {
            helpImageStatus.hasCustomIcon = false;
          }
          // åˆ·æ–°é¢„è§ˆ
          updateImagePreviews();
          renderHelpList();
        } else {
          showToast('é‡ç½®å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (e) {
        showToast('é‡ç½®å¤±è´¥: ' + e.message, 'error');
      }
    }

    // ==================== è°ƒè¯•æ—¥å¿— ====================
    let debugLastId = 0;
    let debugAutoScroll = true;
    let debugPollTimer = null;
    let debugFilter = 'all';

    async function toggleWebDebug (el) {
      const enabling = !el.classList.contains('active');
      try {
        const res = await fetch(`${API_NO_AUTH}/debug/toggle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: enabling }),
        });
        const data = await res.json();
        if (data.code === 0) {
          if (data.data.enabled) {
            el.classList.add('active');
            document.getElementById('debugStatusText').textContent = 'è¿è¡Œä¸­';
            document.getElementById('debugStatusText').className = 'text-sm text-green-500 font-medium';
            startDebugPoll();
            showToast('è°ƒè¯•æ¨¡å¼å·²å¼€å¯', 'success');
          } else {
            el.classList.remove('active');
            document.getElementById('debugStatusText').textContent = 'å·²å…³é—­';
            document.getElementById('debugStatusText').className = 'text-sm text-gray-500';
            stopDebugPoll();
            showToast('è°ƒè¯•æ¨¡å¼å·²å…³é—­', 'info');
          }
        }
      } catch (e) { showToast('æ“ä½œå¤±è´¥: ' + e, 'error'); }
    }

    async function clearDebugLogs () {
      try {
        await fetch(`${API_NO_AUTH}/debug/clear`, { method: 'POST' });
        debugLastId = 0;
        document.getElementById('debugLogContainer').innerHTML = '<div class="text-center text-gray-400 py-12" id="debugEmpty">æ—¥å¿—å·²æ¸…ç©º</div>';
        document.getElementById('debugLogCount').textContent = '0 æ¡';
        showToast('æ—¥å¿—å·²æ¸…ç©º', 'success');
      } catch (e) { showToast('æ¸…ç©ºå¤±è´¥', 'error'); }
    }

    function toggleAutoScroll () {
      debugAutoScroll = !debugAutoScroll;
      const btn = document.getElementById('btnAutoScroll');
      btn.textContent = debugAutoScroll ? 'â¬‡ è‡ªåŠ¨æ»šåŠ¨: å¼€' : 'â¬‡ è‡ªåŠ¨æ»šåŠ¨: å…³';
      btn.className = debugAutoScroll
        ? 'px-3 py-1.5 text-sm bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition'
        : 'px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition';
    }

    function applyDebugFilter () {
      debugFilter = document.getElementById('debugFilter').value;
      const container = document.getElementById('debugLogContainer');
      container.querySelectorAll('.log-entry').forEach(el => {
        const level = el.dataset.level;
        let show = true;
        if (debugFilter === 'api') show = level === 'api';
        else if (debugFilter === 'error') show = level === 'error';
        else if (debugFilter === 'warn') show = level === 'warn' || level === 'error';
        else if (debugFilter === 'debug') show = level === 'debug';
        el.style.display = show ? '' : 'none';
      });
    }

    function formatLogTime (iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString('zh-CN', { hour12: false }) + '.' + String(d.getMilliseconds()).padStart(3, '0');
    }

    function escapeHtml (s) {
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function renderLogEntry (entry) {
      const div = document.createElement('div');
      div.className = `log-entry level-${entry.level}`;
      div.dataset.level = entry.level;

      let html = `<span class="log-time">${formatLogTime(entry.time)}</span>`;
      html += `<span class="log-level">${entry.level}</span> `;
      html += escapeHtml(entry.message);

      // API è¯·æ±‚è¯¦æƒ…ï¼ˆå¯å±•å¼€ï¼‰
      if (entry.level === 'api' && (entry.headers || entry.response)) {
        html += `<details class="log-api-detail">`;
        html += `<summary>å±•å¼€è¯·æ±‚è¯¦æƒ…</summary>`;
        if (entry.headers) {
          html += `<div class="log-api-section"><div class="log-api-section-title">è¯·æ±‚å¤´</div><div class="log-api-content">`;
          for (const [k, v] of Object.entries(entry.headers)) {
            // éšè— API Key ä¸­é—´éƒ¨åˆ†
            const val = k.toLowerCase() === 'authorization' ? v.replace(/(Bearer\s+.{6})(.+)(.{4})/, '$1***$3') : v;
            html += escapeHtml(k) + ': ' + escapeHtml(val) + '\n';
          }
          html += `</div></div>`;
        }
        if (entry.body) {
          html += `<div class="log-api-section"><div class="log-api-section-title">è¯·æ±‚ä½“</div><div class="log-api-content">${escapeHtml(entry.body)}</div></div>`;
        }
        if (entry.response) {
          html += `<div class="log-api-section"><div class="log-api-section-title">å“åº”å†…å®¹ (${entry.status || '-'})</div><div class="log-api-content">`;
          try {
            html += escapeHtml(JSON.stringify(JSON.parse(entry.response), null, 2));
          } catch {
            html += escapeHtml(entry.response);
          }
          html += `</div></div>`;
        }
        html += `</details>`;
      }

      div.innerHTML = html;

      // åº”ç”¨è¿‡æ»¤
      if (debugFilter !== 'all') {
        let show = true;
        if (debugFilter === 'api') show = entry.level === 'api';
        else if (debugFilter === 'error') show = entry.level === 'error';
        else if (debugFilter === 'warn') show = entry.level === 'warn' || entry.level === 'error';
        else if (debugFilter === 'debug') show = entry.level === 'debug';
        if (!show) div.style.display = 'none';
      }

      return div;
    }

    async function fetchDebugLogs () {
      try {
        const res = await fetch(`${API_NO_AUTH}/debug/logs?after=${debugLastId}`);
        const data = await res.json();
        if (data.code !== 0) return;

        // æ›´æ–°å¼€å…³çŠ¶æ€
        const toggle = document.getElementById('webDebugToggle');
        if (data.data.enabled && !toggle.classList.contains('active')) {
          toggle.classList.add('active');
          document.getElementById('debugStatusText').textContent = 'è¿è¡Œä¸­';
          document.getElementById('debugStatusText').className = 'text-sm text-green-500 font-medium';
        }

        const logs = data.data.logs;
        if (!logs || logs.length === 0) return;

        const container = document.getElementById('debugLogContainer');
        // é¦–æ¬¡æœ‰æ—¥å¿—æ—¶ç§»é™¤ç©ºæç¤º
        const empty = document.getElementById('debugEmpty');
        if (empty) empty.remove();

        for (const entry of logs) {
          container.appendChild(renderLogEntry(entry));
          if (entry.id > debugLastId) debugLastId = entry.id;
        }

        // æ›´æ–°è®¡æ•°
        const total = container.querySelectorAll('.log-entry').length;
        document.getElementById('debugLogCount').textContent = total + ' æ¡';

        // è‡ªåŠ¨æ»šåŠ¨
        if (debugAutoScroll) {
          container.scrollTop = container.scrollHeight;
        }
      } catch (e) { /* é™é»˜å¤±è´¥ */ }
    }

    function startDebugPoll () {
      stopDebugPoll();
      fetchDebugLogs();
      debugPollTimer = setInterval(fetchDebugLogs, 1500);
    }

    function stopDebugPoll () {
      if (debugPollTimer) { clearInterval(debugPollTimer); debugPollTimer = null; }
    }

    // åˆ‡æ¢åˆ°è°ƒè¯•é¡µæ—¶æ£€æŸ¥çŠ¶æ€å¹¶å¼€å§‹è½®è¯¢
    const origSwitchPage = switchPage;
    switchPage = function (pageId, el) {
      origSwitchPage(pageId, el);
      if (pageId === 'debug') {
        // æ£€æŸ¥å½“å‰çŠ¶æ€
        fetch(`${API_NO_AUTH}/debug/logs?after=0`).then(r => r.json()).then(d => {
          if (d.data?.enabled) startDebugPoll();
        }).catch(() => { });
      } else {
        // ç¦»å¼€è°ƒè¯•é¡µæ—¶å¦‚æœå¼€ç€å°±ç»§ç»­åå°è½®è¯¢ï¼ˆä¿æŒæ•°æ®è¿ç»­æ€§ï¼‰
      }
    };

    // åˆå§‹åŒ–
    refreshStatus();
    loadConfig();
    loadGroupList();
    loadFriendList();
    initHelpSettings();
  </script>
</body>

</html>